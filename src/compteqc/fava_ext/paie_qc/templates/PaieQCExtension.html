{% set page_title = "Paie Quebec" %}

{% block content %}

{% set summary = extension.payroll_summary() %}
{% set impots = extension.retenues_impot() %}
{% set totaux = extension.totaux() %}

<div class="cqc-page-header">
  <h2>Paie Quebec</h2>
  <span class="cqc-subtitle">Cumulatif annuel {{ extension.annee() }}</span>
</div>

<div class="cqc-kpi-row">
  <div class="cqc-kpi">
    <div class="cqc-kpi-label">Salaire brut YTD</div>
    <div class="cqc-kpi-value">{{ "{:,.2f}".format(totaux.salaire_brut_ytd) }} $</div>
  </div>
  <div class="cqc-kpi">
    <div class="cqc-kpi-label">Retenues employe</div>
    <div class="cqc-kpi-value cqc-error">{{ "{:,.2f}".format(totaux.total_retenues_employe) }} $</div>
  </div>
  <div class="cqc-kpi">
    <div class="cqc-kpi-label">Cotisations employeur</div>
    <div class="cqc-kpi-value cqc-warning">{{ "{:,.2f}".format(totaux.total_cotisations_employeur) }} $</div>
  </div>
  <div class="cqc-kpi">
    <div class="cqc-kpi-label">Salaire net YTD</div>
    <div class="cqc-kpi-value cqc-success">{{ "{:,.2f}".format(totaux.salaire_net_ytd) }} $</div>
  </div>
</div>

<div class="cqc-card-flush">
  <div style="padding: 16px 24px 0;">
    <h3 class="cqc-section-title">Cotisations</h3>
  </div>
  <table class="cqc-table">
    <thead>
      <tr>
        <th>Cotisation</th>
        <th class="montant">Employe YTD</th>
        <th class="montant">Employeur YTD</th>
        <th class="montant">Maximum annuel</th>
        <th>Statut</th>
      </tr>
    </thead>
    <tbody>
      {% for cot in summary %}
      <tr>
        <td>{{ cot.nom }}</td>
        <td class="montant">{{ "{:,.2f}".format(cot.employe) }} $</td>
        <td class="montant">{{ "{:,.2f}".format(cot.employeur) }} $</td>
        <td class="montant">
          {% if cot.maximum_employe > 0 %}
            {{ "{:,.2f}".format(cot.maximum_employe) }} $
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          {% if cot.atteint_employe %}
            <span class="cqc-badge cqc-badge-success">Atteint</span>
          {% elif cot.maximum_employe > 0 %}
            {% set pct = (cot.employe / cot.maximum_employe * 100) | int %}
            <div style="display: flex; align-items: center; gap: 8px;">
              <div class="cqc-progress" style="width: 80px;">
                <div class="cqc-progress-bar" style="width: {{ pct }}%;"></div>
              </div>
              <span style="font-size: 0.85em; color: var(--qc-muted);">{{ "{:,.2f}".format(cot.maximum_employe - cot.employe) }} $ restant</span>
            </div>
          {% else %}
            -
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="cqc-card-flush">
  <div style="padding: 16px 24px 0;">
    <h3 class="cqc-section-title">Retenues d'impot</h3>
  </div>
  <table class="cqc-table">
    <thead>
      <tr>
        <th>Palier</th>
        <th class="montant">Impot retenu YTD</th>
      </tr>
    </thead>
    <tbody>
      {% for imp in impots %}
      <tr>
        <td>{{ imp.palier }}</td>
        <td class="montant">{{ "{:,.2f}".format(imp.montant) }} $</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}
