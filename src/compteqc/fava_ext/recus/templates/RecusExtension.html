{% set page_title = "Recus" %}

{% block content %}

<div class="cqc-page-header">
  <h2>Televersement de recus et factures</h2>
</div>

{% if not extension.upload_disponible() %}
<div class="cqc-alert cqc-alert-info">
  L'extraction automatique par IA sera disponible apres la Phase 5.
  Les fichiers telecharges seront conserves dans le dossier documents/.
</div>
{% endif %}

<div class="cqc-card">
  <form id="upload-form" method="POST"
        action="/{{ g.beancount_file_slug }}/extension/{{ extension.name }}/upload"
        enctype="multipart/form-data">

    <div id="dropzone" class="cqc-dropzone">
      <div class="cqc-dropzone-text">
        <span class="icone">&#128194;</span>
        <strong>Glissez-deposez un fichier ici</strong><br>
        ou cliquez pour selectionner
      </div>
    </div>

    <input type="file" id="fichier-input" name="fichier"
           accept=".pdf,.jpg,.jpeg,.png,.heic"
           style="display: none;">
  </form>

  <p style="font-size: 0.85em; color: var(--qc-muted, #64748B); margin-top: 8px;">
    Formats acceptes : PDF, JPEG, PNG, HEIC
  </p>
</div>

<div class="cqc-card-flush">
  <div style="padding: 16px 24px 0;">
    <h3 class="cqc-section-title">Recus recents</h3>
  </div>
  {% set recents = extension.recent_uploads() %}
  {% if recents %}
  <table class="cqc-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Fichier</th>
        <th>Chemin</th>
      </tr>
    </thead>
    <tbody>
      {% for doc in recents %}
      <tr>
        <td>{{ doc.date }}</td>
        <td>{{ doc.filename }}</td>
        <td style="font-size: 0.85em; color: var(--qc-muted, #64748B);">{{ doc.chemin }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="cqc-empty">Aucun recu recent.</div>
  {% endif %}
</div>

<script>
(function() {
  var dropzone = document.getElementById('dropzone');
  var fileInput = document.getElementById('fichier-input');
  var form = document.getElementById('upload-form');

  dropzone.addEventListener('click', function() {
    fileInput.click();
  });

  fileInput.addEventListener('change', function() {
    if (fileInput.files.length > 0) {
      form.submit();
    }
  });

  dropzone.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.stopPropagation();
    dropzone.classList.add('dragover');
  });

  dropzone.addEventListener('dragleave', function(e) {
    e.preventDefault();
    e.stopPropagation();
    dropzone.classList.remove('dragover');
  });

  dropzone.addEventListener('drop', function(e) {
    e.preventDefault();
    e.stopPropagation();
    dropzone.classList.remove('dragover');

    if (e.dataTransfer.files.length > 0) {
      fileInput.files = e.dataTransfer.files;
      form.submit();
    }
  });
})();
</script>

{% endblock %}
