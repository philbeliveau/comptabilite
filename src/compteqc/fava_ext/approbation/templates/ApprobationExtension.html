{% set page_title = "File d'approbation" %}

{% block content %}

{% set pending = extension.pending_transactions() %}

<div class="cqc-page-header">
  <h2>File d'approbation</h2>
  <span class="cqc-subtitle">{{ pending | length }} transaction(s) en attente de revision</span>
</div>

{% if pending %}
<form method="POST" action="/{{ g.beancount_file_slug }}/extension/{{ extension.name }}/approuver">

  <div class="cqc-actions-bar">
    <button type="button" class="cqc-btn cqc-btn-outline" onclick="toggleAll(true)">Tout selectionner</button>
    <button type="button" class="cqc-btn cqc-btn-outline" onclick="toggleAll(false)">Tout deselectionner</button>
    <button type="submit" class="cqc-btn cqc-btn-success">Approuver la selection</button>
    <label class="cqc-label" style="margin-left: auto;">
      <input type="checkbox" name="confirmer_gros_montants">
      Confirmer les montants &gt; 2 000 $
    </label>
  </div>

  <div class="cqc-card-flush">
    <table class="cqc-table">
      <thead>
        <tr>
          <th style="width: 40px;"><input type="checkbox" id="select-all" onchange="toggleAll(this.checked)"></th>
          <th>Date</th>
          <th>Beneficiaire</th>
          <th>Narration</th>
          <th class="montant">Montant</th>
          <th>Categorie proposee</th>
          <th>Confiance</th>
        </tr>
      </thead>
      <tbody>
        {% for txn in pending %}
        <tr>
          <td><input type="checkbox" name="ids" value="{{ loop.index0 }}"></td>
          <td>{{ txn.date }}</td>
          <td>{{ txn.payee }}</td>
          <td>{{ txn.narration }}</td>
          <td class="montant {{ 'cqc-gros-montant' if txn.gros_montant else '' }}">{{ "{:,.2f}".format(txn.montant) }} $</td>
          <td>{{ txn.get("compte_propose", "-") }}</td>
          <td>
            {% if txn.niveau == "elevee" %}
              <span class="cqc-badge cqc-badge-success">Elevee</span>
            {% elif txn.niveau == "moderee" %}
              <span class="cqc-badge cqc-badge-warning">Moderee</span>
            {% else %}
              <span class="cqc-badge cqc-badge-error">Revision</span>
            {% endif %}
            <span class="cqc-source-tag">{{ txn.source }}</span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</form>

<div class="cqc-card">
  <h3 class="cqc-section-title">Rejeter une transaction</h3>
  <form method="POST" action="/{{ g.beancount_file_slug }}/extension/{{ extension.name }}/rejeter"
        style="display: flex; align-items: flex-end; gap: 12px; flex-wrap: wrap;">
    <label class="cqc-label" style="flex-direction: column; align-items: flex-start;">
      Indice de la transaction
      <input type="number" name="id" min="0" max="{{ pending | length - 1 }}" required
             class="cqc-input" style="width: 70px;">
    </label>
    <label class="cqc-label" style="flex-direction: column; align-items: flex-start; flex: 1; min-width: 200px;">
      Compte corrige (optionnel)
      <input type="text" name="compte_corrige" placeholder="Depenses:Bureau:Fournitures"
             class="cqc-input" style="width: 100%;">
    </label>
    <button type="submit" class="cqc-btn cqc-btn-error">Rejeter</button>
  </form>
</div>

{% else %}
<div class="cqc-empty">
  Aucune transaction en attente.
</div>
{% endif %}

<script>
function toggleAll(checked) {
  document.querySelectorAll('input[name="ids"]').forEach(function(cb) {
    cb.checked = checked;
  });
  var selectAll = document.getElementById('select-all');
  if (selectAll) selectAll.checked = checked;
}
</script>

{% endblock %}
