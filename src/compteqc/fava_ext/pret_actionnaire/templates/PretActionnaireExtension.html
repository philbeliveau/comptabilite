{% set page_title = "Pret actionnaire" %}

{% block content %}

{% set status = extension.loan_status() %}
{% set s152 = extension.s152_status() %}

<div class="cqc-page-header">
  <h2>Pret actionnaire</h2>
  <span class="cqc-subtitle">Statut et suivi s.15(2)</span>
</div>

{% if s152 %}
  {% if s152.niveau_alerte == "normal" %}
    <div class="cqc-alert cqc-alert-success">
  {% elif s152.niveau_alerte == "attention" %}
    <div class="cqc-alert cqc-alert-amber">
  {% elif s152.niveau_alerte == "urgent" %}
    <div class="cqc-alert cqc-alert-warning">
  {% else %}
    <div class="cqc-alert cqc-alert-error">
  {% endif %}
    <strong>Alerte s.15(2)</strong>
    Date d'inclusion : <strong>{{ s152.date_inclusion }}</strong>
    ({{ s152.jours_restants }} jour{{ 's' if s152.jours_restants != 1 else '' }} restant{{ 's' if s152.jours_restants != 1 else '' }})<br>
    {{ s152.message }}
  </div>
{% endif %}

<div class="cqc-solde-box">
  <div class="cqc-solde-montant">{{ "{:,.2f}".format(status.solde_net) }} $</div>
  <div class="cqc-solde-direction">{{ status.direction }}</div>
</div>

{% if s152 and s152.avances %}
<div class="cqc-card-flush">
  <div style="padding: 16px 24px 0;">
    <h3 class="cqc-section-title">Avances ouvertes (s.15(2))</h3>
  </div>
  <table class="cqc-table">
    <thead>
      <tr>
        <th>Date de l'avance</th>
        <th class="montant">Montant initial</th>
        <th class="montant">Solde restant</th>
        <th>Date d'inclusion</th>
        <th>Jours restants</th>
        <th>Niveau</th>
      </tr>
    </thead>
    <tbody>
      {% for a in s152.avances %}
      <tr>
        <td>{{ a.date_avance }}</td>
        <td class="montant">{{ "{:,.2f}".format(a.montant) }} $</td>
        <td class="montant">{{ "{:,.2f}".format(a.solde_restant) }} $</td>
        <td>{{ a.date_inclusion }}</td>
        <td>{{ a.jours_restants }}</td>
        <td>
          {% if a.niveau == "normal" %}
            <span class="cqc-badge cqc-badge-success">Normal</span>
          {% elif a.niveau == "attention" %}
            <span class="cqc-badge cqc-badge-warning">Attention</span>
          {% elif a.niveau == "urgent" %}
            <span class="cqc-badge cqc-badge-warning">Urgent</span>
          {% else %}
            <span class="cqc-badge cqc-badge-error">CRITIQUE</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<div class="cqc-card-flush">
  <div style="padding: 16px 24px 0;">
    <h3 class="cqc-section-title">Historique des mouvements</h3>
  </div>
  {% if status.mouvements %}
  <table class="cqc-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Description</th>
        <th class="montant">Montant</th>
        <th class="montant">Solde courant</th>
      </tr>
    </thead>
    <tbody>
      {% for m in status.mouvements %}
      <tr>
        <td>{{ m.date }}</td>
        <td>{{ m.description }}</td>
        <td class="montant {{ 'cqc-positif' if m.montant > 0 else 'cqc-negatif' }}">
          {{ "{:+,.2f}".format(m.montant) }} $
        </td>
        <td class="montant">{{ "{:,.2f}".format(m.solde_courant) }} $</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="cqc-empty">Aucun mouvement enregistre pour cet exercice.</div>
  {% endif %}
</div>

{% endblock %}
