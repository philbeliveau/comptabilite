---
phase: 01-ledger-foundation-and-import-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/compteqc/__init__.py
  - src/compteqc/models/__init__.py
  - src/compteqc/models/transaction.py
  - src/compteqc/ledger/__init__.py
  - src/compteqc/ledger/validation.py
  - src/compteqc/ledger/git.py
  - src/compteqc/ledger/fichiers.py
  - ledger/main.beancount
  - ledger/comptes.beancount
  - tests/test_ledger.py
autonomous: true
requirements:
  - FOUND-01
  - FOUND-02
  - FOUND-03
  - FOUND-04
  - FOUND-05

must_haves:
  truths:
    - "Le projet Python s'installe avec uv et toutes les dependances sont resolues"
    - "Le fichier ledger/main.beancount passe bean-check sans erreur"
    - "Le plan comptable contient ~50-60 comptes avec noms francais et metadata GIFI"
    - "Un git commit automatique est cree apres chaque modification du ledger qui passe bean-check"
    - "La structure modulaire du projet est en place (cli/, ingestion/, categorisation/, ledger/, models/)"
  artifacts:
    - path: "pyproject.toml"
      provides: "Configuration projet avec dependances Beancount, beangulp, beanquery, ofxtools, typer, rich, pydantic, pyyaml"
      contains: "beancount"
    - path: "ledger/main.beancount"
      provides: "Fichier racine du ledger avec options et includes"
      contains: "operating_currency"
    - path: "ledger/comptes.beancount"
      provides: "Plan comptable GIFI-mappe pour consultant IT Quebec CCPC"
      contains: "gifi"
    - path: "src/compteqc/ledger/validation.py"
      provides: "Wrapper bean-check pour validation du ledger"
      contains: "bean_check"
    - path: "src/compteqc/ledger/git.py"
      provides: "Auto-commit git apres import"
      contains: "auto_commit"
  key_links:
    - from: "ledger/main.beancount"
      to: "ledger/comptes.beancount"
      via: "include directive"
      pattern: 'include "comptes.beancount"'
    - from: "src/compteqc/ledger/validation.py"
      to: "ledger/main.beancount"
      via: "bean-check subprocess"
      pattern: "bean-check"
    - from: "src/compteqc/ledger/git.py"
      to: "src/compteqc/ledger/validation.py"
      via: "validate before commit"
      pattern: "valider.*commit|bean_check"
---

<objective>
Initialiser le projet CompteQC : structure Python avec uv, ledger Beancount v3 fonctionnel, plan comptable Quebec GIFI-mappe en francais (~50-60 comptes), modules de validation (bean-check) et auto-commit git.

Purpose: Etablir la fondation sur laquelle les importateurs, la categorisation et le CLI seront construits. Sans un ledger valide et une structure de projet propre, rien d'autre ne peut fonctionner.
Output: Projet Python installable, ledger Beancount qui passe bean-check, plan comptable complet, utilitaires de validation et git.
</objective>

<execution_context>
@/Users/philippebeliveau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/philippebeliveau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-ledger-foundation-and-import-pipeline/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialiser le projet Python et la structure modulaire</name>
  <files>
    pyproject.toml
    src/compteqc/__init__.py
    src/compteqc/cli/__init__.py
    src/compteqc/ingestion/__init__.py
    src/compteqc/categorisation/__init__.py
    src/compteqc/ledger/__init__.py
    src/compteqc/models/__init__.py
    src/compteqc/models/transaction.py
    data/imports/.gitkeep
    data/processed/.gitkeep
    rules/.gitkeep
  </files>
  <action>
  Creer le projet Python avec uv :

  1. Depuis le repertoire du projet, executer :
     ```
     uv init --name compteqc --package
     uv python pin 3.12
     ```
     Si le projet existe deja (pyproject.toml present), adapter plutot que reinitialiser.

  2. Configurer pyproject.toml :
     - name: "compteqc"
     - version: "0.1.0"
     - python: ">=3.12"
     - Dependances principales : beancount>=3.2, beangulp>=0.2, beanquery>=0.2, ofxtools>=0.9, typer>=0.24, rich, pydantic>=2, pyyaml
     - Dependances dev : pytest, pytest-cov, ruff, mypy
     - Script entry point : `cqc = "compteqc.cli.app:app"`
     - Configurer ruff (line-length=100, target Python 3.12)

  3. Executer `uv sync` pour installer toutes les dependances.

  4. Creer la structure de repertoires :
     ```
     src/compteqc/
       __init__.py          (version = "0.1.0")
       cli/__init__.py      (vide)
       ingestion/__init__.py (vide)
       categorisation/__init__.py (vide)
       ledger/__init__.py   (vide)
       models/__init__.py   (vide)
     data/imports/.gitkeep
     data/processed/.gitkeep
     rules/.gitkeep
     tests/__init__.py
     tests/fixtures/.gitkeep
     ```

  5. Creer src/compteqc/models/transaction.py :
     - Pydantic BaseModel `TransactionNormalisee` avec les champs :
       - date: datetime.date
       - montant: Decimal (JAMAIS float)
       - devise: str = "CAD"
       - beneficiaire: str (payee)
       - description: str (narration)
       - memo: str | None = None
       - source: str (ex: "rbc-cheques-csv", "rbc-ofx")
       - numero_reference: str | None = None (FITID pour OFX)
     - Utiliser `from decimal import Decimal` partout
     - Configurer Pydantic pour interdire float -> Decimal coercion implicite

  6. Verifier que `uv run python -c "import compteqc; print(compteqc.__version__)"` fonctionne.
  </action>
  <verify>
  ```bash
  uv sync
  uv run python -c "import compteqc; print(compteqc.__version__)"
  uv run python -c "from compteqc.models.transaction import TransactionNormalisee; from decimal import Decimal; t = TransactionNormalisee(date='2026-01-15', montant=Decimal('100.00'), beneficiaire='Test', description='Test tx', source='test'); print(t.montant, type(t.montant))"
  uv run ruff check src/
  ```
  Toutes les commandes reussissent. Le montant est de type Decimal.
  </verify>
  <done>Le projet Python s'installe proprement avec uv, toutes les dependances se resolvent, la structure modulaire est en place, et le modele TransactionNormalisee utilise Decimal pour les montants.</done>
</task>

<task type="auto">
  <name>Task 2: Creer le ledger Beancount avec plan comptable Quebec GIFI-mappe</name>
  <files>
    ledger/main.beancount
    ledger/comptes.beancount
    ledger/2026/01.beancount
    src/compteqc/ledger/validation.py
    src/compteqc/ledger/git.py
    src/compteqc/ledger/fichiers.py
    tests/test_ledger.py
  </files>
  <action>
  1. Creer ledger/main.beancount :
     ```beancount
     option "title" "CompteQC - Corporation Consultation IT (Quebec)"
     option "operating_currency" "CAD"
     option "name_assets" "Actifs"
     option "name_liabilities" "Passifs"
     option "name_equity" "Capital"
     option "name_income" "Revenus"
     option "name_expenses" "Depenses"

     include "comptes.beancount"
     ; Les fichiers mensuels seront ajoutes dynamiquement
     ```
     NOTE : Beancount exige que les noms de comptes de premier niveau correspondent aux option "name_*". Utiliser ces 5 noms exacts : Actifs, Passifs, Capital, Revenus, Depenses (sans accents pour eviter tout risque de compatibilite).

  2. Creer ledger/comptes.beancount avec ~50-60 comptes en francais, GIFI en metadata.
     Organiser par section :

     **ACTIFS (GIFI 1000-1999) :**
     - Actifs:Banque:RBC:Cheques (gifi: "1001") -- Encaisse
     - Actifs:Banque:RBC:Epargne (gifi: "1001") -- Epargne
     - Actifs:ComptesClients (gifi: "1060") -- Comptes a recevoir
     - Actifs:TPS-Payee (gifi: "1300") -- Credits TPS
     - Actifs:TVQ-Payee (gifi: "1300") -- Credits TVQ
     - Actifs:Prepaye:Assurances (gifi: "1302") -- Frais payes d'avance
     - Actifs:Immobilisations:Informatique (gifi: "1740") -- CCA classe 50
     - Actifs:Immobilisations:Mobilier (gifi: "1740") -- CCA classe 8
     - Actifs:Immobilisations:Amortissement-Cumule (gifi: "1742") -- Amortissement

     **PASSIFS (GIFI 2000-2999) :**
     - Passifs:CartesCredit:RBC (gifi: "2700") -- Carte credit
     - Passifs:TPS-Percue (gifi: "2620") -- TPS collectee
     - Passifs:TVQ-Percue (gifi: "2620") -- TVQ collectee
     - Passifs:Salaires-A-Payer (gifi: "2620") -- Salaires a payer
     - Passifs:Retenues-A-Payer (gifi: "2620") -- Retenues salariales
     - Passifs:Cotisations-Employeur (gifi: "2620") -- Part employeur
     - Passifs:Impots-A-Payer:Federal (gifi: "2620") -- Impot fed a payer
     - Passifs:Impots-A-Payer:Quebec (gifi: "2620") -- Impot QC a payer
     - Passifs:Pret-Actionnaire (gifi: "2480") -- Pret actionnaire (s.15(2))

     **CAPITAUX PROPRES (GIFI 3000-3999) :**
     - Capital:Actions-Ordinaires (gifi: "3500")
     - Capital:Benefices-Non-Repartis (gifi: "3600")
     - Capital:Dividendes-Declares (gifi: "3701")
     - Capital:Apports (gifi: "3470") -- Mises de fonds

     **REVENUS (GIFI 8000+) :**
     - Revenus:Consultation (gifi: "8000") -- Revenu de consultation
     - Revenus:Interets (gifi: "8090") -- Revenus d'interets
     - Revenus:Autres (gifi: "8230") -- Autres revenus

     **DEPENSES (GIFI 8600-9000) :**
     - Depenses:Salaires:Brut (gifi: "8960")
     - Depenses:Salaires:RRQ-Employeur (gifi: "8960")
     - Depenses:Salaires:RQAP-Employeur (gifi: "8960")
     - Depenses:Salaires:AE-Employeur (gifi: "8960")
     - Depenses:Salaires:FSS (gifi: "8960")
     - Depenses:Salaires:CNESST (gifi: "8960")
     - Depenses:Salaires:Normes-Travail (gifi: "8960")
     - Depenses:Bureau:Loyer (gifi: "8810")
     - Depenses:Bureau:Internet-Telecom (gifi: "8811")
     - Depenses:Bureau:Abonnements-Logiciels (gifi: "8811")
     - Depenses:Bureau:Fournitures (gifi: "8811")
     - Depenses:Bureau:Entretien (gifi: "8811")
     - Depenses:Honoraires-Professionnels:Comptable (gifi: "8860")
     - Depenses:Honoraires-Professionnels:Juridique (gifi: "8860")
     - Depenses:Honoraires-Professionnels:Autres (gifi: "8860")
     - Depenses:Assurances:Responsabilite (gifi: "8690")
     - Depenses:Assurances:Autres (gifi: "8690")
     - Depenses:Vehicule:Carburant (gifi: "9281")
     - Depenses:Vehicule:Entretien (gifi: "9281")
     - Depenses:Vehicule:Assurance (gifi: "9281")
     - Depenses:Vehicule:Stationnement (gifi: "9281")
     - Depenses:Deplacement:Transport (gifi: "9200")
     - Depenses:Deplacement:Hebergement (gifi: "9200")
     - Depenses:Repas-Representation (gifi: "8523")
     - Depenses:Formation (gifi: "8811")
     - Depenses:Publicite-Marketing (gifi: "8520")
     - Depenses:Frais-Bancaires (gifi: "8710")
     - Depenses:Interet:Bancaire (gifi: "8710")
     - Depenses:Amortissement (gifi: "8670")
     - Depenses:Impots:Federal (gifi: "9060")
     - Depenses:Impots:Quebec (gifi: "9060")
     - Depenses:TPS-Remise (gifi: "8760") -- TPS nette a remettre
     - Depenses:TVQ-Remise (gifi: "8760") -- TVQ nette a remettre
     - Depenses:Divers (gifi: "9270")
     - Depenses:Non-Classe (gifi: "9990") -- Transactions en attente de classification

     Toutes les dates d'ouverture : 2025-01-01. Devise : CAD.
     Chaque directive `open` a une ligne `gifi: "XXXX"` en metadata (indente par 2 espaces sous l'open).

  3. Creer ledger/2026/ repertoire avec un fichier 01.beancount vide (juste un commentaire : "; Transactions janvier 2026").

  4. Creer src/compteqc/ledger/validation.py :
     - Fonction `valider_ledger(chemin_main: Path) -> tuple[bool, list[str]]`
       - Execute `bean-check <chemin>` en subprocess
       - Retourne (True, []) si pas d'erreur, (False, [messages]) sinon
       - Utilise `uv run bean-check` pour s'assurer du bon environnement
     - Fonction `charger_comptes_existants(chemin_main: Path) -> set[str]`
       - Utilise `beancount.loader.load_file()` pour charger le ledger
       - Retourne le set de tous les noms de comptes ouverts
       - Utile pour valider qu'un compte de categorisation existe avant de l'assigner

  5. Creer src/compteqc/ledger/git.py :
     - Fonction `auto_commit(repertoire: Path, message: str) -> bool`
       - Execute `git add` sur les fichiers *.beancount dans le repertoire ledger/
       - Execute aussi `git add` sur rules/ et data/processed/ si modifies
       - Verifie qu'il y a des changements stages (`git diff --cached --quiet`)
       - Execute `git commit -m <message>` si changements
       - Retourne True si commit cree, False sinon
       - IMPORTANT : Appeler valider_ledger() AVANT auto_commit(). Ne jamais commit un ledger invalide.
       - Le cwd pour git doit etre la racine du projet (parent de ledger/), pas ledger/ lui-meme

  6. Creer src/compteqc/ledger/fichiers.py :
     - Fonction `chemin_fichier_mensuel(annee: int, mois: int, base_dir: Path) -> Path`
       - Retourne le chemin vers le fichier mensuel (ex: ledger/2026/02.beancount)
       - Cree le repertoire annee si necessaire
       - Cree le fichier avec un commentaire header si inexistant
     - Fonction `ajouter_include(chemin_main: Path, chemin_relatif: str) -> bool`
       - Ajoute une ligne `include "<chemin>"` dans main.beancount si pas deja presente
       - Place l'include a la fin du fichier
     - Fonction `ecrire_transactions(chemin: Path, transactions_beancount: str) -> None`
       - Append du texte Beancount (transactions formatees) a la fin du fichier

  7. Creer tests/test_ledger.py :
     - Test que bean-check passe sur le ledger initial (ledger/main.beancount)
     - Test que le plan comptable contient au moins 45 comptes ouverts
     - Test que chaque compte ouvert a un metadata gifi
     - Test que valider_ledger retourne True sur un ledger valide
     - Test que charger_comptes_existants retourne les comptes attendus (Depenses:Non-Classe doit etre present)
     - Test que chemin_fichier_mensuel cree le fichier si inexistant (utiliser tmp_path)
     - Test que auto_commit fonctionne (utiliser un repo git temporaire dans tmp_path)
  </action>
  <verify>
  ```bash
  uv run bean-check ledger/main.beancount
  uv run pytest tests/test_ledger.py -v
  uv run python -c "from beancount import loader; e,_,_ = loader.load_file('ledger/main.beancount'); accounts = [e for e in e if hasattr(e, 'account')]; print(f'{len(accounts)} comptes ouverts')"
  ```
  bean-check retourne 0 (succes). Les tests passent. Le nombre de comptes est >= 45.
  </verify>
  <done>Le ledger Beancount est fonctionnel avec un plan comptable de ~50-60 comptes en francais avec mappage GIFI, bean-check passe, les utilitaires de validation/git/fichiers sont testes, et la structure de fichiers mensuels est en place.</done>
</task>

</tasks>

<verification>
1. `uv sync` reussit sans erreur
2. `uv run bean-check ledger/main.beancount` retourne 0
3. `uv run pytest tests/test_ledger.py -v` -- tous les tests passent
4. Le plan comptable contient au moins 45 comptes avec metadata GIFI
5. La structure de repertoires est complete (src/compteqc/{cli,ingestion,categorisation,ledger,models}/)
6. Les montants dans TransactionNormalisee sont Decimal (pas float)
</verification>

<success_criteria>
- Le projet s'installe et s'execute via uv
- bean-check valide le ledger initial sans erreur
- Le plan comptable a ~50-60 comptes avec noms francais et codes GIFI
- Les tests unitaires passent pour validation, git, et gestion de fichiers
- La structure modulaire est prete pour recevoir les importateurs (Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/01-ledger-foundation-and-import-pipeline/01-01-SUMMARY.md`
</output>
