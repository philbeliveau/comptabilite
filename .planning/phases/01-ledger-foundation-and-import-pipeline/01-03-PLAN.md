---
phase: 01-ledger-foundation-and-import-pipeline
plan: 03
type: execute
wave: 3
depends_on:
  - 01-01
  - 01-02
files_modified:
  - src/compteqc/cli/app.py
  - src/compteqc/cli/importer.py
  - src/compteqc/cli/rapports.py
  - tests/test_cli.py
autonomous: true
requirements:
  - CLI-01
  - CLI-06

must_haves:
  truths:
    - "L'utilisateur peut executer `cqc importer <fichier>` et voir les transactions importees dans le ledger"
    - "L'utilisateur peut executer `cqc soldes` et voir les soldes de tous les comptes actifs"
    - "L'utilisateur peut executer `cqc rapport resultats` et voir un etat des resultats (P&L)"
    - "L'utilisateur peut executer `cqc rapport bilan` et voir un bilan sommaire"
    - "L'interface CLI est entierement en francais (aide, messages, erreurs)"
    - "Apres un import reussi, un git commit automatique est cree"
  artifacts:
    - path: "src/compteqc/cli/app.py"
      provides: "Application Typer principale avec sous-commandes"
      contains: "app = typer.Typer"
    - path: "src/compteqc/cli/importer.py"
      provides: "Commande d'import de fichiers bancaires"
      contains: "def fichier"
    - path: "src/compteqc/cli/rapports.py"
      provides: "Commandes de rapport (soldes, resultats, bilan)"
      contains: "def soldes"
  key_links:
    - from: "src/compteqc/cli/importer.py"
      to: "src/compteqc/ingestion/rbc_cheques.py"
      via: "detection et appel d'importateur"
      pattern: "RBCChequesImporter|RBCCarteImporter|RBCOfxImporter"
    - from: "src/compteqc/cli/importer.py"
      to: "src/compteqc/categorisation/moteur.py"
      via: "categorisation post-import"
      pattern: "MoteurRegles|appliquer_categorisation"
    - from: "src/compteqc/cli/importer.py"
      to: "src/compteqc/ledger/git.py"
      via: "auto-commit apres import"
      pattern: "auto_commit"
    - from: "src/compteqc/cli/rapports.py"
      to: "beanquery"
      via: "requetes SQL sur le ledger"
      pattern: "run_query|beanquery"
---

<objective>
Construire le CLI `cqc` en francais avec les commandes d'import et de reporting. A la fin de ce plan, l'utilisateur dispose d'un outil en ligne de commande complet pour importer des fichiers bancaires RBC et consulter les soldes et rapports du ledger.

Purpose: Le CLI est l'interface utilisateur de Phase 1. C'est par le CLI que l'utilisateur interagit quotidiennement avec le systeme : importer des releves et verifier les comptes.
Output: Commande `cqc` installable via pyproject.toml avec sous-commandes importer, soldes, et rapport.
</objective>

<execution_context>
@/Users/philippebeliveau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/philippebeliveau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-ledger-foundation-and-import-pipeline/01-RESEARCH.md
@.planning/phases/01-ledger-foundation-and-import-pipeline/01-01-SUMMARY.md
@.planning/phases/01-ledger-foundation-and-import-pipeline/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Creer l'application CLI et la commande d'import</name>
  <files>
    src/compteqc/cli/app.py
    src/compteqc/cli/importer.py
  </files>
  <action>
  1. Creer src/compteqc/cli/app.py :
     - Application Typer principale :
       ```python
       import typer
       app = typer.Typer(
           name="cqc",
           help="CompteQC - Comptabilite pour consultant IT au Quebec",
           no_args_is_help=True,
       )
       ```
     - Importer et enregistrer les sous-commandes (importer, rapport)
     - Option globale `--ledger` / `-l` pour specifier le chemin du fichier main.beancount (defaut: "ledger/main.beancount")
     - Option globale `--regles` / `-r` pour specifier le chemin du fichier de regles (defaut: "rules/categorisation.yaml")
     - Callback principal qui affiche la version si `--version` est passe
     - TOUTE l'aide et les messages en FRANCAIS

  2. Creer src/compteqc/cli/importer.py :
     - Sous-commande `importer` avec une commande `fichier` :
       ```
       cqc importer fichier <chemin_fichier> [--compte CHEQUES|CARTE|AUTO]
       ```
     - Le flux complet d'import :
       a. Detecter le type de fichier (CSV ou OFX) par extension et contenu
       b. Si CSV : detecter si c'est cheques ou carte credit (par headers ou par option --compte)
       c. Si OFX/QFX : utiliser l'importateur OFX
       d. Si --compte AUTO (defaut) : essayer tous les importateurs en sequence (identify)
       e. Charger le ledger existant pour deduplication : `loader.load_file(main.beancount)` -> passer les entries comme `existing`
       f. Extraire les transactions avec l'importateur detecte
       g. Charger les regles et appliquer la categorisation (MoteurRegles + appliquer_categorisation)
       h. Determiner le fichier mensuel cible (par date de la premiere transaction) via fichiers.chemin_fichier_mensuel
       i. Formater les transactions en texte Beancount (utiliser `beancount.parser.printer.format_entry()`)
       j. Ecrire dans le fichier mensuel via fichiers.ecrire_transactions
       k. Ajouter l'include dans main.beancount si necessaire via fichiers.ajouter_include
       l. Valider le ledger avec validation.valider_ledger
       m. Si valide : archiver le fichier source, puis auto_commit git
       n. Si invalide : ANNULER les ecritures (restaurer le fichier mensuel a son etat precedent), afficher les erreurs, et exit 1

     - Affichage Rich apres import :
       - Tableau resume : nombre de transactions importees, nombre de doublons ignores, nombre categorisees, nombre non-classees
       - Liste des transactions non-classees avec date, montant, beneficiaire (pour que l'utilisateur sache quoi ajouter comme regle)
       - Message de confirmation du git commit

     - Gestion d'erreurs :
       - Fichier introuvable : message clair en francais
       - Format non reconnu : lister les formats supportes
       - bean-check echoue : afficher les erreurs et rollback
       - Aucune nouvelle transaction : message informatif (pas un erreur)

  3. Verifier que le entry point `cqc` dans pyproject.toml pointe vers `compteqc.cli.app:app`.
     Si pyproject.toml utilise `[project.scripts]`, verifier :
     ```toml
     [project.scripts]
     cqc = "compteqc.cli.app:app"
     ```

  4. S'assurer que `uv run cqc --help` affiche l'aide en francais.
     S'assurer que `uv run cqc importer --help` affiche l'aide de la sous-commande.
  </action>
  <verify>
  ```bash
  uv run cqc --help
  uv run cqc --version
  uv run cqc importer --help
  # Test d'import reel avec la fixture CSV
  cp tests/fixtures/rbc_cheques_sample.csv /tmp/test_import.csv
  uv run cqc importer fichier /tmp/test_import.csv
  uv run bean-check ledger/main.beancount
  git log --oneline -1  # Verifier le commit automatique
  ```
  L'aide est en francais. L'import fonctionne. Le ledger est valide. Un commit git existe.
  </verify>
  <done>La commande `cqc importer fichier` importe un fichier bancaire RBC, categorise les transactions, ecrit dans le ledger, valide avec bean-check, et fait un git commit automatique. L'interface est entierement en francais.</done>
</task>

<task type="auto">
  <name>Task 2: Creer les commandes de rapport (soldes, resultats, bilan) et les tests CLI</name>
  <files>
    src/compteqc/cli/rapports.py
    src/compteqc/cli/app.py
    tests/test_cli.py
  </files>
  <action>
  1. Creer src/compteqc/cli/rapports.py :
     - Sous-commande `soldes` :
       ```
       cqc soldes [--compte FILTRE]
       ```
       - Charge le ledger avec `beancount.loader.load_file()`
       - Execute une requete beanquery : `SELECT account, sum(position) WHERE account ~ '{filtre}' ORDER BY account`
       - Si pas de filtre : afficher tous les comptes avec solde non-nul
       - Affiche un Rich Table avec colonnes : Compte, Solde (CAD)
       - Formate les montants avec 2 decimales et separateur de milliers

     - Sous-commande `rapport` avec sous-sous-commandes :

       a. `cqc rapport balance` (trial balance / balance de verification) :
          - Requete : `SELECT account, sum(position) ORDER BY account`
          - Affiche tous les comptes avec solde, groupes par categorie (Actifs, Passifs, Capital, Revenus, Depenses)
          - Verifie que Total Debit = Total Credit (sinon avertissement)

       b. `cqc rapport resultats` (P&L / etat des resultats) :
          - Options : `--debut DATE --fin DATE` (defaut : annee courante)
          - Requete sur les comptes Revenus et Depenses
          - Affiche : Revenus totaux, Depenses par categorie, Resultat net (Revenus - Depenses)
          - Rich Table avec mise en forme (revenus en vert, depenses en rouge, resultat net en gras)

       c. `cqc rapport bilan` (balance sheet / bilan) :
          - Affiche : Actifs, Passifs, Capitaux propres
          - Verifie l'equation comptable : Actifs = Passifs + Capitaux propres

     - Sous-commande `cqc revue` (sommaire des transactions non-classees) :
       - Requete beanquery pour trouver les transactions avec posting vers Depenses:Non-Classe
       - Affiche : date, montant, beneficiaire, narration
       - Affiche le nombre total et le montant total non-classe
       - Sert a identifier les transactions qui ont besoin de regles de categorisation

     - Pour toutes les commandes de rapport :
       - Utiliser Rich Console et Rich Table pour le formatage
       - Les montants en CAD avec 2 decimales
       - Messages en francais
       - Si le ledger est vide (aucune transaction) : message informatif, pas d'erreur

  2. Mettre a jour src/compteqc/cli/app.py :
     - Enregistrer les sous-commandes rapports comme app.add_typer() ou app.command()
     - S'assurer que la structure est :
       ```
       cqc
         importer
           fichier <path>
         soldes [--compte]
         rapport
           balance
           resultats [--debut --fin]
           bilan
         revue
       ```

  3. Creer tests/test_cli.py :
     - Utiliser `typer.testing.CliRunner` pour tester les commandes
     - Setup fixture : creer un ledger temporaire (copie de ledger/main.beancount + comptes.beancount) dans tmp_path
     - Test `cqc --help` : retourne 0, contient "CompteQC"
     - Test `cqc --version` : retourne 0, contient la version
     - Test `cqc importer fichier <fixture_csv>` : retourne 0, le ledger a de nouvelles transactions
     - Test `cqc soldes` sur un ledger avec des transactions : retourne 0, affiche des comptes
     - Test `cqc rapport balance` : retourne 0, affiche un tableau
     - Test `cqc rapport resultats` : retourne 0, affiche revenus et depenses
     - Test `cqc rapport bilan` : retourne 0, affiche actifs/passifs/capitaux
     - Test `cqc revue` : retourne 0, affiche les transactions non-classees
     - Test import d'un fichier inexistant : retourne 1, message d'erreur en francais
     - Test import d'un fichier non-reconnu : retourne 1, message d'erreur en francais
     - IMPORTANT : les tests doivent fonctionner avec un ledger isole (pas le ledger principal). Utiliser tmp_path et copier les fichiers necessaires.
  </action>
  <verify>
  ```bash
  uv run pytest tests/test_cli.py -v
  uv run cqc soldes
  uv run cqc rapport balance
  uv run cqc rapport resultats
  uv run cqc rapport bilan
  uv run cqc revue
  ```
  Tous les tests passent. Les commandes de rapport fonctionnent et affichent des tableaux Rich en francais.
  </verify>
  <done>Le CLI `cqc` est complet avec les commandes importer, soldes, rapport (balance/resultats/bilan), et revue. L'interface est entierement en francais avec des tableaux Rich formates. Les tests CLI couvrent le flux d'import et les rapports.</done>
</task>

</tasks>

<verification>
1. `uv run cqc --help` affiche l'aide en francais
2. `uv run cqc importer fichier tests/fixtures/rbc_cheques_sample.csv` reussit et cree un git commit
3. `uv run bean-check ledger/main.beancount` passe apres l'import
4. `uv run cqc soldes` affiche les soldes des comptes
5. `uv run cqc rapport resultats` affiche l'etat des resultats
6. `uv run cqc revue` liste les transactions non-classees
7. `uv run pytest tests/test_cli.py -v` -- tous les tests passent
8. `uv run pytest tests/ -v` -- TOUS les tests de la phase passent
</verification>

<success_criteria>
- Le CLI `cqc` est installable et fonctionnel via `uv run cqc`
- L'import de fichiers bancaires fonctionne de bout en bout (parse -> categorise -> ecrit -> valide -> commit)
- Les rapports (soldes, balance, resultats, bilan) affichent des donnees correctes du ledger
- La commande revue identifie les transactions non-classees
- L'interface est entierement en francais
- Tous les tests passent
</success_criteria>

<output>
After completion, create `.planning/phases/01-ledger-foundation-and-import-pipeline/01-03-SUMMARY.md`
</output>
