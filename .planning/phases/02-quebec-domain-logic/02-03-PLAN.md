---
phase: 02-quebec-domain-logic
plan: 03
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/compteqc/quebec/taxes/__init__.py
  - src/compteqc/quebec/taxes/calcul.py
  - src/compteqc/quebec/taxes/traitement.py
  - src/compteqc/quebec/taxes/sommaire.py
  - rules/taxes.yaml
  - tests/test_taxes.py
autonomous: true
requirements: [TAX-01, TAX-02, TAX-03, TAX-04, TAX-05, TAX-06]

must_haves:
  truths:
    - "GST (5%) and QST (9.975%) are extracted separately from tax-included totals, each rounded independently to $0.01"
    - "Tax treatment rules (taxable/exempt/zero-rated) apply per-category with per-vendor overrides, and per-client rules control tax collection on revenue"
    - "System produces a net GST/QST remittance summary by filing period showing collected, ITCs/ITRs, and net payable"
    - "GST-exempt and QST-exempt items generate no tax postings"
    - "Reconciliation check confirms every transaction with a TPS posting has a matching TVQ posting (except exempt/zero-rated)"
  artifacts:
    - path: "src/compteqc/quebec/taxes/calcul.py"
      provides: "Tax extraction/application math with separate GST/QST rounding"
      contains: "extraire_taxes"
    - path: "src/compteqc/quebec/taxes/traitement.py"
      provides: "Tax treatment rule engine with category defaults and vendor/client overrides"
      contains: "determiner_traitement"
    - path: "src/compteqc/quebec/taxes/sommaire.py"
      provides: "Filing period summaries and reconciliation checks"
      contains: "generer_sommaire_periode"
    - path: "rules/taxes.yaml"
      provides: "YAML configuration for tax treatment rules"
      contains: "categories"
    - path: "tests/test_taxes.py"
      provides: "Tests for tax math, treatment rules, summaries, and reconciliation"
      min_lines: 80
  key_links:
    - from: "src/compteqc/quebec/taxes/traitement.py"
      to: "rules/taxes.yaml"
      via: "loads YAML config for treatment rules"
      pattern: "yaml\\.safe_load|charger_regles"
    - from: "src/compteqc/quebec/taxes/calcul.py"
      to: "src/compteqc/quebec/rates.py"
      via: "uses tps_taux and tvq_taux from rates"
      pattern: "taux_tps|taux_tvq"
    - from: "src/compteqc/quebec/taxes/sommaire.py"
      to: "beancount"
      via: "queries ledger for tax account balances by period"
      pattern: "loader\\.load_file|Passifs:TPS|Actifs:TPS"
---

<objective>
Implement GST/QST tax extraction math, tax treatment rules engine, filing period summaries, and reconciliation checks.

Purpose: Every business expense must have GST and QST tracked separately, and every revenue transaction must have correct tax collection based on client location. The system must produce net remittance summaries for filing periods and verify GST/QST consistency across all transactions.

Output: Tax calculation module, YAML-driven treatment rules, period summaries, and reconciliation validation.
</objective>

<execution_context>
@/Users/philippebeliveau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/philippebeliveau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-quebec-domain-logic/02-RESEARCH.md
@.planning/phases/01-ledger-foundation-and-import-pipeline/01-01-SUMMARY.md
@ledger/comptes.beancount
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implementer le calcul TPS/TVQ et le moteur de regles de traitement fiscal (TDD)</name>
  <files>
    src/compteqc/quebec/taxes/__init__.py
    src/compteqc/quebec/taxes/calcul.py
    src/compteqc/quebec/taxes/traitement.py
    rules/taxes.yaml
    tests/test_taxes.py
  </files>
  <action>
TDD: Write tests FIRST, then implement.

**RED phase — Create `tests/test_taxes.py` with failing tests:**

Tax extraction tests:
- `test_extraire_taxes_standard`: $114.98 total → pre_tax ~$100.01, TPS ~$5.00, TVQ ~$9.98. Verify TPS and TVQ rounded independently.
- `test_extraire_taxes_rounding_discrepancy`: Pick a total where independent rounding causes $0.01 discrepancy (e.g., $57.49). Verify `pre_tax + tps + tvq` may differ from total by at most $0.01. The pre_tax is the "plug" value: `pre_tax = total - tps - tvq`.
- `test_extraire_taxes_zero`: $0.00 → all zeros.
- `test_extraire_taxes_petit_montant`: $1.15 → verify no division errors.
- `test_appliquer_taxes_revenu`: Pre-tax $1000 → TPS = $50.00, TVQ = $99.75, total = $1,149.75.

Tax treatment tests:
- `test_traitement_defaut_taxable`: Unknown vendor/category → "taxable"
- `test_traitement_categorie_exempt`: "Depenses:Frais-Bancaires" → "exempt"
- `test_traitement_vendeur_override_exempt`: Vendor matching ".*RBC.*" → "exempt" (even if category is normally taxable)
- `test_traitement_vendeur_tps_seulement`: Vendor matching ".*AMAZON.*WEB.*SERVICES.*" → "tps_seulement"
- `test_traitement_client_quebec_tps_tvq`: Client matching ".*PROCOM.*" → "tps_tvq"
- `test_traitement_client_international_aucune`: Client matching ".*INTERNATIONAL.*" → "aucune_taxe"
- `test_vendeur_override_wins_over_categorie`: A vendor override takes precedence over category default.

**GREEN phase — Create `src/compteqc/quebec/taxes/calcul.py`:**

```python
def extraire_taxes(total_ttc: Decimal, taux_tps: Decimal, taux_tvq: Decimal) -> tuple[Decimal, Decimal, Decimal]:
    """Extrait TPS et TVQ d'un montant TTC. Returns (avant_taxes, tps, tvq).
    TPS and TVQ rounded independently. Pre-tax is plug value: total - tps - tvq."""

def appliquer_taxes(montant_ht: Decimal, taux_tps: Decimal, taux_tvq: Decimal) -> tuple[Decimal, Decimal, Decimal]:
    """Applique TPS et TVQ sur un montant HT (pour revenus). Returns (tps, tvq, total_ttc)."""

def extraire_taxes_selon_traitement(total: Decimal, traitement: str, taux_tps: Decimal, taux_tvq: Decimal) -> tuple[Decimal, Decimal, Decimal]:
    """Route based on treatment type: taxable, exempt, zero-rated, tps_seulement.
    Returns (avant_taxes, tps, tvq). For exempt: returns (total, 0, 0)."""
```

All Decimal math, ROUND_HALF_UP, never combine 14.975%.

**Create `rules/taxes.yaml`:**

Use the exact YAML structure from the research doc's Code Examples section. Include:
- `defaut: taxable`
- `categories.exempt`: financial fees, interest, insurance, salaries
- `categories.zero`: certain training (placeholder)
- `vendeurs.exempt`: regex patterns for banks, insurance companies
- `vendeurs.tps_seulement`: out-of-province suppliers (AWS)
- `clients.tps_tvq`: Quebec clients (Procom)
- `clients.tps_seulement`: out-of-province Canadian clients
- `clients.aucune_taxe`: international clients

**Create `src/compteqc/quebec/taxes/traitement.py`:**

```python
def charger_regles_taxes(chemin: str = "rules/taxes.yaml") -> ReglesTaxes:
    """Load and validate tax treatment rules from YAML."""

def determiner_traitement_depense(compte: str, beneficiaire: str, regles: ReglesTaxes) -> str:
    """Determine tax treatment for an expense: 'taxable', 'exempt', 'zero', 'tps_seulement'.
    Priority: vendor override > category default > global default ('taxable')."""

def determiner_traitement_revenu(client: str, type_produit: str, regles: ReglesTaxes) -> str:
    """Determine tax treatment for revenue: 'tps_tvq', 'tps_seulement', 'aucune_taxe'.
    Checks client rules first, then product type rules."""
```

Use Pydantic for the ReglesTaxes model (validate YAML structure). Vendor/client matching uses `re.match` on regex patterns from YAML.

Create `src/compteqc/quebec/taxes/__init__.py` with module exports.
  </action>
  <verify>
    `uv run pytest tests/test_taxes.py -v` — all tests pass.
    `uv run python -c "from compteqc.quebec.taxes.calcul import extraire_taxes; from decimal import Decimal; print(extraire_taxes(Decimal('114.98'), Decimal('0.05'), Decimal('0.09975')))"` — prints reasonable (pre_tax, tps, tvq) tuple.
  </verify>
  <done>
    Tax extraction calculates GST and QST separately with independent rounding. Treatment rules load from YAML with vendor override > category default > global default priority. Revenue tax treatment supports per-client and per-product rules. All math uses Decimal.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implementer les sommaires de periode de declaration et la verification de concordance TPS/TVQ</name>
  <files>
    src/compteqc/quebec/taxes/sommaire.py
    tests/test_taxes.py
  </files>
  <action>
**Create `src/compteqc/quebec/taxes/sommaire.py`:**

Define a dataclass `SommairePeriode`:
```python
@dataclass
class SommairePeriode:
    debut: datetime.date
    fin: datetime.date
    tps_percue: Decimal       # GST collected on revenue
    tvq_percue: Decimal       # QST collected on revenue
    tps_payee: Decimal        # GST paid on expenses (ITCs)
    tvq_payee: Decimal        # QST paid on expenses (ITRs)
    tps_nette: Decimal        # tps_percue - tps_payee (net GST remittance)
    tvq_nette: Decimal        # tvq_percue - tvq_payee (net QST remittance)
    nb_transactions: int      # Number of transactions in period
```

Functions:

```python
def generer_sommaire_periode(
    entries: list,  # Beancount entries
    debut: datetime.date,
    fin: datetime.date,
) -> SommairePeriode:
    """Generate GST/QST summary for a filing period.
    Sums postings to Passifs:TPS-Percue, Passifs:TVQ-Percue (collected)
    and Actifs:TPS-Payee, Actifs:TVQ-Payee (paid/ITCs/ITRs)
    within the date range.
    Net = collected - paid (positive = owes CRA/RQ, negative = refund)."""

def generer_sommaires_annuels(
    entries: list,
    annee: int,
    frequence: str = "annuel",  # "annuel" or "trimestriel"
) -> list[SommairePeriode]:
    """Generate summaries for all filing periods in a year.
    Annuel: one period (Jan 1 - Dec 31).
    Trimestriel: four periods (Q1: Jan-Mar, Q2: Apr-Jun, Q3: Jul-Sep, Q4: Oct-Dec)."""

def verifier_concordance_tps_tvq(entries: list, annee: int) -> list[dict]:
    """Reconciliation check: verify every transaction that has a TPS posting
    also has a matching TVQ posting (and vice versa).
    Exempt and zero-rated transactions are excluded (no tax postings expected).
    Returns list of mismatches: [{date, narration, has_tps, has_tvq, issue}]."""
```

Implementation approach for `generer_sommaire_periode`:
- Filter entries to Transaction type within date range
- For each transaction, sum postings to the four tax accounts
- Note: liability accounts (Percue) will have negative balances (credits). The `tps_percue` field should be the absolute value for display.
- Asset accounts (Payee) will have positive balances (debits). These are the ITCs/ITRs.

Implementation for `verifier_concordance_tps_tvq`:
- For each transaction in the year, check if it has any posting to TPS-related accounts and TVQ-related accounts
- If a transaction has a TPS posting but no TVQ posting (or vice versa), it's a mismatch
- Exception: transactions to exempt accounts (from rules) should have neither
- Return the list of mismatches for human review

**Add tests to `tests/test_taxes.py`:**

- `test_sommaire_periode_simple`: Create 3 test transactions (2 expenses with tax, 1 revenue with tax) and verify the summary sums correctly.
- `test_sommaire_trimestriel`: Create transactions across 2 quarters and verify each quarter's summary is independent.
- `test_concordance_ok`: All transactions have matching TPS+TVQ postings → empty mismatch list.
- `test_concordance_mismatch`: Transaction with TPS posting but missing TVQ → returned as mismatch.
- `test_concordance_exempt_ok`: Transaction to Depenses:Frais-Bancaires with no tax postings → not flagged.

For test transactions, build them manually using `beancount.core.data.Transaction` and `create_simple_posting` (same pattern as existing tests in the project).
  </action>
  <verify>
    `uv run pytest tests/test_taxes.py -v` — all tests pass (both Task 1 and Task 2 tests).
    `uv run ruff check src/compteqc/quebec/taxes/` — no lint errors.
  </verify>
  <done>
    Filing period summaries produce correct net GST/QST remittance amounts (collected - ITCs/ITRs) for annual or quarterly periods. Reconciliation check identifies transactions with mismatched TPS/TVQ postings. All 6 TAX requirements are met.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_taxes.py -v` — all pass
2. `uv run ruff check src/compteqc/quebec/taxes/` — no lint errors
3. Tax extraction: $114.98 produces separate TPS and TVQ amounts that approximately sum back to the original
4. Treatment rules: vendor override correctly takes precedence over category default
5. Reconciliation catches TPS/TVQ mismatches
</verification>

<success_criteria>
- GST and QST are always calculated separately (never combined 14.975% rate)
- Each tax amount is independently rounded to $0.01
- Treatment rules follow priority: vendor > category > default
- Revenue tax treatment supports per-client rules (Quebec, out-of-province, international)
- Period summaries show collected, ITCs/ITRs, and net remittance
- Reconciliation check catches mismatches between TPS and TVQ postings
- All tests pass, no float anywhere
</success_criteria>

<output>
After completion, create `.planning/phases/02-quebec-domain-logic/02-03-SUMMARY.md`
</output>
