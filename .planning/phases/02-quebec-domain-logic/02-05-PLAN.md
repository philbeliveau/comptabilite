---
phase: 02-quebec-domain-logic
plan: 05
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/compteqc/quebec/pret_actionnaire/suivi.py
  - tests/test_pret_actionnaire.py
autonomous: true
requirements: [LOAN-01]
gap_closure: true

must_haves:
  truths:
    - "obtenir_etat_pret(entries, fin_exercice) returns an EtatPret derived from Beancount ledger postings to Passifs:Pret-Actionnaire"
    - "Debit postings (positive) to Passifs:Pret-Actionnaire become avance MouvementPret objects"
    - "Credit postings (negative) to Passifs:Pret-Actionnaire become remboursement MouvementPret objects"
    - "Function filters entries by fiscal year based on fin_exercice"
  artifacts:
    - path: "src/compteqc/quebec/pret_actionnaire/suivi.py"
      provides: "obtenir_etat_pret ledger-reading bridge"
      contains: "def obtenir_etat_pret"
    - path: "tests/test_pret_actionnaire.py"
      provides: "Tests for ledger-reading bridge"
      contains: "test_obtenir_etat_pret"
  key_links:
    - from: "src/compteqc/quebec/pret_actionnaire/suivi.py"
      to: "beancount.core.data"
      via: "isinstance(entry, data.Transaction) and posting.account check"
      pattern: "Passifs:Pret-Actionnaire"
    - from: "obtenir_etat_pret"
      to: "calculer_etat_pret"
      via: "builds MouvementPret list then delegates"
      pattern: "calculer_etat_pret\\(mouvements\\)"
---

<objective>
Add the missing ledger-reading bridge function `obtenir_etat_pret(entries, fin_exercice)` to suivi.py so the shareholder loan module can autonomously derive loan state from Beancount postings.

Purpose: Close the LOAN-01 gap — without this function, callers must manually construct MouvementPret objects, defeating the "tracks all personal-vs-business transactions" goal.
Output: Working obtenir_etat_pret() with tests, completing LOAN-01 requirement.
</objective>

<execution_context>
@/Users/philippebeliveau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/philippebeliveau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-quebec-domain-logic/02-04-SUMMARY.md
@src/compteqc/quebec/pret_actionnaire/suivi.py
@src/compteqc/quebec/paie/ytd.py
@tests/test_pret_actionnaire.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add obtenir_etat_pret ledger-reading bridge with TDD</name>
  <files>
    src/compteqc/quebec/pret_actionnaire/suivi.py
    tests/test_pret_actionnaire.py
  </files>
  <action>
**RED phase — write failing tests first in tests/test_pret_actionnaire.py:**

Add these test cases at the end of the existing test file:

1. `test_obtenir_etat_pret_from_entries` — Create mock Beancount Transaction entries with postings to `Passifs:Pret-Actionnaire`. Include:
   - A debit posting of +5000 (avance on 2026-03-15)
   - A credit posting of -2000 (remboursement on 2026-06-01)
   - A debit posting of +3000 (avance on 2026-09-10)
   - Call `obtenir_etat_pret(entries, fin_exercice=datetime.date(2026, 12, 31))`
   - Assert solde == Decimal("6000") (5000 - 2000 + 3000)
   - Assert len(avances_ouvertes) == 2 (first partially repaid, second full)

2. `test_obtenir_etat_pret_filters_by_fiscal_year` — Create entries spanning two years (2025 and 2026). Call with fin_exercice=2026-12-31. Assert only 2026 entries are included.

3. `test_obtenir_etat_pret_ignores_other_accounts` — Create entries with postings to both `Passifs:Pret-Actionnaire` and `Passifs:Retenues:QPP-Base`. Assert only Pret-Actionnaire postings appear in the result.

4. `test_obtenir_etat_pret_empty_entries` — Pass empty list. Assert solde == 0, no mouvements, no avances_ouvertes.

5. `test_obtenir_etat_pret_narration_as_description` — Verify that the Transaction narration is used as MouvementPret.description.

To build mock Beancount entries, follow the pattern from `tests/test_paie_integration.py` or construct `data.Transaction` objects directly using `data.new_metadata`, `data.Transaction(meta, date, flag, payee, narration, tags, links, postings)`, and `data.Posting(account, amount.Amount(D(str), 'CAD'), None, None, None, None)`. Import from `beancount.core import data, amount` and `beancount.core.number import D`.

Run tests — they MUST fail (obtenir_etat_pret does not exist yet).

**GREEN phase — implement obtenir_etat_pret in suivi.py:**

Add to suivi.py:

1. Add imports at top: `from beancount.core import data` and `from beancount.core.number import D` (only data is strictly needed but D is conventional).

2. Add constant: `COMPTE_PRET_ACTIONNAIRE = "Passifs:Pret-Actionnaire"`

3. Add function `obtenir_etat_pret(entries: list, fin_exercice: datetime.date) -> EtatPret`:
   - Derive `annee = fin_exercice.year` for filtering
   - Iterate entries, filter `isinstance(entry, data.Transaction)` and `entry.date.year == annee`
   - For each matching transaction, iterate postings where `posting.account == COMPTE_PRET_ACTIONNAIRE`
   - Map posting to MouvementPret:
     - `date = entry.date`
     - `montant = posting.units.number` (Decimal, positive = debit = avance, negative = credit = remboursement)
     - `description = entry.narration or ""`
     - `type = "avance" if montant > 0 else "remboursement"`
   - Collect all MouvementPret objects into a list
   - Return `calculer_etat_pret(mouvements)`

Follow the EXACT same Beancount entry-reading pattern used in `src/compteqc/quebec/paie/ytd.py` (isinstance check, date filter, posting.account match, posting.units.number for amount).

Run tests — ALL must pass (including the existing 12 tests).

**Sign convention rationale:** In Beancount, `Passifs:Pret-Actionnaire` is a liability account. A debit (positive posting) increases what the shareholder owes the corporation. A credit (negative posting) decreases it (repayment). This aligns with the existing MouvementPret convention where positive = actionnaire emprunte, negative = remboursement.
  </action>
  <verify>
Run `cd /Users/philippebeliveau/Desktop/Notebook/comptabilite && uv run pytest tests/test_pret_actionnaire.py -v` — all tests pass (existing 12 + new 5 = 17 total).
Run `uv run python -c "from compteqc.quebec.pret_actionnaire.suivi import obtenir_etat_pret; print('import OK')"` — no import error.
  </verify>
  <done>
obtenir_etat_pret(entries, fin_exercice) exists in suivi.py, reads Beancount entries, filters by fiscal year, maps postings to MouvementPret with correct sign convention, delegates to calculer_etat_pret, and all 17 tests pass.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_pret_actionnaire.py -v` — 17 tests pass
2. `uv run pytest tests/ -v` — no regressions in other test files
3. `grep "def obtenir_etat_pret" src/compteqc/quebec/pret_actionnaire/suivi.py` — function exists
4. `grep "Passifs:Pret-Actionnaire" src/compteqc/quebec/pret_actionnaire/suivi.py` — account constant present
5. `grep "from beancount" src/compteqc/quebec/pret_actionnaire/suivi.py` — beancount import present
</verification>

<success_criteria>
- obtenir_etat_pret(entries, fin_exercice) function exists and returns EtatPret
- Function reads Beancount Transaction entries and filters postings to Passifs:Pret-Actionnaire
- Debit (positive) postings map to avance, credit (negative) to remboursement
- Fiscal year filtering works correctly
- All 17+ tests pass with no regressions
- LOAN-01 gap from VERIFICATION.md is fully closed
</success_criteria>

<output>
After completion, create `.planning/phases/02-quebec-domain-logic/02-05-SUMMARY.md`
</output>
