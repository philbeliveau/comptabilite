---
phase: 02-quebec-domain-logic
plan: 02
type: tdd
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/compteqc/quebec/paie/impot_federal.py
  - src/compteqc/quebec/paie/impot_quebec.py
  - src/compteqc/quebec/paie/moteur.py
  - src/compteqc/quebec/paie/journal.py
  - src/compteqc/cli/paie.py
  - tests/test_impot.py
  - tests/test_paie_integration.py
autonomous: true
requirements: [PAY-01, PAY-08, PAY-09, PAY-11, CLI-04]

must_haves:
  truths:
    - "Federal income tax is calculated using T4127 formulas with 14% lowest rate, K constants, K2Q credits, and 16.5% Quebec abatement"
    - "Quebec provincial tax is calculated using TP-1015.F-V formulas with correct brackets and personal credits"
    - "User can run `cqc paie lancer 5000` and see a full payroll breakdown (gross, every deduction, every employer contribution, net pay)"
    - "Payroll generates a complete balanced Beancount transaction with ~15 postings using the sub-accounts from Plan 02-01"
    - "Generated payroll transaction passes bean-check when appended to the ledger"
  artifacts:
    - path: "src/compteqc/quebec/paie/impot_federal.py"
      provides: "Federal tax withholding per T4127 with Quebec abatement"
      contains: "calculer_impot_federal"
    - path: "src/compteqc/quebec/paie/impot_quebec.py"
      provides: "Quebec tax withholding per TP-1015.F-V"
      contains: "calculer_impot_quebec"
    - path: "src/compteqc/quebec/paie/moteur.py"
      provides: "Payroll engine orchestrating all calculations"
      contains: "calculer_paie"
    - path: "src/compteqc/quebec/paie/journal.py"
      provides: "Beancount transaction generation from payroll results"
      contains: "generer_transaction_paie"
    - path: "src/compteqc/cli/paie.py"
      provides: "CLI command for running payroll"
      contains: "lancer"
  key_links:
    - from: "src/compteqc/quebec/paie/moteur.py"
      to: "src/compteqc/quebec/paie/cotisations.py"
      via: "calls all contribution calculation functions"
      pattern: "calculer_qpp|calculer_rqap|calculer_ae|calculer_fss|calculer_cnesst|calculer_normes"
    - from: "src/compteqc/quebec/paie/moteur.py"
      to: "src/compteqc/quebec/paie/impot_federal.py"
      via: "calls federal tax calculation"
      pattern: "calculer_impot_federal"
    - from: "src/compteqc/quebec/paie/journal.py"
      to: "beancount.core.data"
      via: "creates Transaction with create_simple_posting"
      pattern: "data\\.Transaction|create_simple_posting"
    - from: "src/compteqc/cli/paie.py"
      to: "src/compteqc/quebec/paie/moteur.py"
      via: "CLI invokes payroll engine"
      pattern: "calculer_paie"
---

<objective>
Implement federal and Quebec income tax withholding calculations, the payroll orchestration engine, Beancount journal entry generation, and the CLI command for running payroll.

Purpose: This plan wires together the contribution calculations from Plan 02-01 with tax withholding formulas to produce a complete payroll run. The user gets a single CLI command that calculates everything, shows a full breakdown, and posts a balanced Beancount transaction.

Output: Working `cqc paie lancer <montant>` command that produces correct payroll calculations and ledger entries.
</objective>

<execution_context>
@/Users/philippebeliveau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/philippebeliveau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-quebec-domain-logic/02-RESEARCH.md
@.planning/phases/02-quebec-domain-logic/02-01-SUMMARY.md
@ledger/comptes.beancount
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implementer l'impot federal (T4127) et l'impot Quebec (TP-1015.F-V) avec tests TDD</name>
  <files>
    src/compteqc/quebec/paie/impot_federal.py
    src/compteqc/quebec/paie/impot_quebec.py
    tests/test_impot.py
  </files>
  <action>
TDD: Write tests FIRST, then implement.

**RED phase — Create `tests/test_impot.py` with failing tests:**

Test federal tax withholding (`calculer_impot_federal_periode`):
- Test with annualized $60,000 income: bracket 14%, K=0. T3 = 0.14 * 60000 - 0 - K1 - K2Q - K4. K1 = 0.14 * 16452 = $2,303.28. K4 = 0.14 * 1428 = $199.92. K2Q includes QPP base portion + EI + RQAP credits at 14%. T1 = T3 * (1 - 0.165). De-annualize: T1 / 26.
- Test with annualized $120,000: bracket 20.5%, K=$3,804.
- Test zero-income returns zero tax.
- Test T1 never goes below zero.

Test Quebec tax withholding (`calculer_impot_quebec_periode`):
- Test with annualized $60,000: bracket 14%, K=0. Y = 0.14 * 60000 - 0 - K1 - E. K1 = 0.14 * 18952 = $2,653.28. E = 0.14 * (QPP + RQAP credits).
- Test with annualized $120,000: bracket 19%, K=$2,717.
- Test zero-income returns zero.

Each test function takes a gross bi-weekly salary and returns the per-period tax withholding amount (annual tax / nb_periodes).

**GREEN phase — Create `src/compteqc/quebec/paie/impot_federal.py`:**

Function `calculer_impot_federal_periode(salaire_brut_periode: Decimal, nb_periodes: int, taux: TauxAnnuels, cotisations_annuelles: dict[str, Decimal]) -> Decimal`:
1. Annualize: `A = salaire_brut_periode * nb_periodes`
2. Find bracket (R, K) from `taux.tranches_federales`
3. K1 = `Decimal("0.14") * taux.montant_personnel_federal` (basic personal credit)
4. K2Q: QPP base credit = `cotisations_annuelles["qpp_base"] * Decimal("0.053") / Decimal("0.063")`. Then K2Q = `Decimal("0.14") * (qpp_base_credit + cotisations_annuelles["ae"] + cotisations_annuelles["rqap"])`
5. K4 = `Decimal("0.14") * Decimal("1428")` (Canada employment credit)
6. T3 = max(0, R * A - K - K1 - K2Q - K4)
7. T1 = max(0, T3 * (1 - Decimal("0.165")))  — Quebec abatement
8. Return (T1 / nb_periodes).quantize(Decimal("0.01"))

The `cotisations_annuelles` dict contains annualized contribution amounts (period amount * nb_periodes) for credits.

**Create `src/compteqc/quebec/paie/impot_quebec.py`:**

Function `calculer_impot_quebec_periode(salaire_brut_periode: Decimal, nb_periodes: int, taux: TauxAnnuels, cotisations_annuelles: dict[str, Decimal]) -> Decimal`:
1. Annualize: `A = salaire_brut_periode * nb_periodes`
2. Find bracket (T, K) from `taux.tranches_quebec`
3. K1 = `Decimal("0.14") * taux.montant_personnel_quebec`
4. E = `Decimal("0.14") * (cotisations_annuelles["qpp_total"] + cotisations_annuelles["rqap"])` — Quebec uses full QPP for credits (not base portion only)
5. Y = max(0, T * A - K - K1 - E)
6. Return (Y / nb_periodes).quantize(Decimal("0.01"))

IMPORTANT: Federal uses lowest rate (0.14) for ALL credits. Quebec also uses its lowest rate (0.14) for credits. Both happen to be 14% in 2026, but they come from different bracket systems.

NOTE from research (MEDIUM confidence): The Quebec formula may have additional deductions not captured here (e.g., "deduction for workers" ~$1,450). Implement the core formula and add a TODO comment noting this should be validated against Revenu Quebec's WebRAS calculator.
  </action>
  <verify>
    `uv run pytest tests/test_impot.py -v` — all tests pass.
    Federal tax for $60K annualized should be a reasonable amount (~$4,000-5,000 annual, ~$150-200 per period after abatement).
    Quebec tax for $60K should be similar range (~$4,000-6,000 annual, ~$150-230 per period).
  </verify>
  <done>
    Federal and Quebec income tax withholding functions calculate correct per-period amounts using T4127 and TP-1015.F-V formulas respectively. Federal includes 16.5% Quebec abatement. All math uses Decimal. Tests pass with known-good bracket calculations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Construire le moteur de paie, le generateur de journal Beancount, et la commande CLI</name>
  <files>
    src/compteqc/quebec/paie/moteur.py
    src/compteqc/quebec/paie/journal.py
    src/compteqc/cli/paie.py
    tests/test_paie_integration.py
  </files>
  <action>
**1. Create `src/compteqc/quebec/paie/moteur.py`** — the payroll orchestration engine:

Define a Pydantic model `ResultatPaie` (or frozen dataclass) containing ALL payroll result fields:
- `brut: Decimal` — gross salary
- `numero_periode: int` — pay period number
- `nb_periodes: int` — total periods per year (default 26)
- Employee deductions: `qpp_base: Decimal`, `qpp_supp1: Decimal`, `qpp_supp2: Decimal`, `rqap: Decimal`, `ae: Decimal`, `impot_federal: Decimal`, `impot_quebec: Decimal`
- Employer contributions: `qpp_base_employeur: Decimal`, `qpp_supp1_employeur: Decimal`, `qpp_supp2_employeur: Decimal`, `rqap_employeur: Decimal`, `ae_employeur: Decimal`, `fss: Decimal`, `cnesst: Decimal`, `normes_travail: Decimal`
- `total_retenues: Decimal` — sum of employee deductions
- `total_cotisations_employeur: Decimal` — sum of employer contributions
- `net: Decimal` — brut - total_retenues

Function `calculer_paie(brut: Decimal, numero_periode: int, chemin_ledger: str, annee: int = 2026, nb_periodes: int = 26) -> ResultatPaie`:
1. Load rates via `obtenir_taux(annee)`
2. Get YTD cumuls via `obtenir_cumuls_annuels(chemin_ledger, annee)`
3. Calculate each contribution using functions from cotisations.py, passing YTD for cap enforcement
4. Build annualized contribution dict for tax credit calculations
5. Calculate federal tax via `calculer_impot_federal_periode`
6. Calculate Quebec tax via `calculer_impot_quebec_periode`
7. Compute totals and net pay
8. Return `ResultatPaie` with all fields populated

**2. Create `src/compteqc/quebec/paie/journal.py`** — Beancount transaction generation:

Function `generer_transaction_paie(date_paie: datetime.date, resultat: ResultatPaie) -> data.Transaction`:
- Creates one Beancount transaction with ~15 postings
- Uses the sub-accounts created in Plan 02-01:
  - Dr `Depenses:Salaires:Brut` = brut
  - Cr `Passifs:Retenues:QPP-Base` = -qpp_base
  - Cr `Passifs:Retenues:QPP-Supp1` = -qpp_supp1
  - Cr `Passifs:Retenues:QPP-Supp2` = -qpp_supp2
  - Cr `Passifs:Retenues:RQAP` = -rqap
  - Cr `Passifs:Retenues:AE` = -ae
  - Cr `Passifs:Retenues:Impot-Federal` = -impot_federal
  - Cr `Passifs:Retenues:Impot-Quebec` = -impot_quebec
  - Cr `Actifs:Banque:RBC:Cheques` = -net
  - Dr `Depenses:Salaires:RRQ-Employeur` = qpp_base_employeur + qpp_supp1_employeur + qpp_supp2_employeur
  - Dr `Depenses:Salaires:RQAP-Employeur` = rqap_employeur
  - Dr `Depenses:Salaires:AE-Employeur` = ae_employeur
  - Dr `Depenses:Salaires:FSS` = fss
  - Dr `Depenses:Salaires:CNESST` = cnesst
  - Dr `Depenses:Salaires:Normes-Travail` = normes_travail
  - Cr `Passifs:Cotisations-Employeur:QPP` = -(qpp_base_employeur + qpp_supp1_employeur + qpp_supp2_employeur)
  - Cr `Passifs:Cotisations-Employeur:RQAP` = -rqap_employeur
  - Cr `Passifs:Cotisations-Employeur:AE` = -ae_employeur
  - Cr `Passifs:Cotisations-Employeur:FSS` = -fss
  - Cr `Passifs:Cotisations-Employeur:CNESST` = -cnesst
  - Cr `Passifs:Cotisations-Employeur:Normes-Travail` = -normes_travail
- Transaction metadata: `type: "paie"`, `periode: str(numero_periode)`, `brut: str(brut)`
- Tags: `frozenset({"paie"})`
- Narration: `f"Paie #{numero_periode} - Salaire brut {brut} CAD"`
- Flag: `"*"` (cleared)

**3. Create `src/compteqc/cli/paie.py`** — CLI command:

Create a Typer sub-app `app = typer.Typer()` with command:

`@app.command("lancer")` taking:
- `montant_brut: Decimal` (argument)
- `--periode: int` (optional, auto-detects next period from ledger YTD count + 1)
- `--nb-periodes: int` (default 26, bi-weekly)
- `--annee: int` (default current year)
- `--dry-run: bool` (default False — shows breakdown without posting)
- `--ledger: str` (default "ledger/main.beancount")

Workflow:
1. Call `calculer_paie()` to get ResultatPaie
2. Display full breakdown using Rich table:
   - Section "Retenues employe" with each deduction line
   - Section "Cotisations employeur" with each contribution line
   - Totals row and Net pay
3. If not dry-run: generate Beancount transaction via `generer_transaction_paie()`, write to monthly file using `ledger.fichiers` utilities, validate with bean-check, auto-commit
4. If dry-run: print "[Mode simulation — aucune ecriture au ledger]"

Wire this into the main CLI app. Check existing `src/compteqc/cli/__init__.py` for how to register the sub-app. If there is a main app already, add `app.add_typer(paie_app, name="paie")`. If not, create the main app and register paie as a subcommand.

**4. Create `tests/test_paie_integration.py`:**
- Test `calculer_paie` with $5,000 bi-weekly gross, period 1, empty ledger (no YTD) → verify net = brut - sum(deductions), all fields populated
- Test journal entry generation: verify transaction has correct number of postings, all amounts are Decimal, transaction balances (sum of postings = 0)
- Test that generated transaction narration contains "Paie #" and tag "paie" is present
  </action>
  <verify>
    `uv run pytest tests/test_impot.py tests/test_paie_integration.py -v` — all tests pass.
    `uv run python -m compteqc.cli.paie lancer 5000 --dry-run --ledger ledger/main.beancount` — shows payroll breakdown without posting.
    Or if CLI is wired: `uv run cqc paie lancer 5000 --dry-run` — shows breakdown.
  </verify>
  <done>
    `cqc paie lancer <montant>` calculates all deductions and employer contributions, displays a Rich breakdown table, generates a balanced Beancount transaction with ~15 postings using sub-accounts, and posts to the ledger (or dry-run mode). Federal tax includes 16.5% Quebec abatement. Integration tests verify end-to-end flow.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_impot.py tests/test_paie_integration.py -v` — all pass
2. `uv run cqc paie lancer 5000 --dry-run` shows complete breakdown with sensible numbers
3. `uv run ruff check src/compteqc/quebec/paie/ src/compteqc/cli/paie.py` — no lint errors
4. Payroll transaction balances: sum of all postings = 0 (verify in test)
5. No float literals in any payroll module
</verification>

<success_criteria>
- Federal tax uses T4127 formulas with 14% lowest rate and 16.5% Quebec abatement
- Quebec tax uses TP-1015.F-V bracket structure with correct personal credits
- `calculer_paie()` returns a complete ResultatPaie with all fields populated
- Generated Beancount transaction has ~20 postings, balances to zero, uses correct sub-accounts
- CLI command shows full breakdown and supports --dry-run mode
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-quebec-domain-logic/02-02-SUMMARY.md`
</output>
