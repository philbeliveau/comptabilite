---
phase: 05-reporting-cpa-export-and-document-management
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/compteqc/documents/__init__.py
  - src/compteqc/documents/upload.py
  - src/compteqc/documents/extraction.py
  - src/compteqc/documents/matching.py
  - src/compteqc/documents/beancount_link.py
  - src/compteqc/cli/receipt.py
  - src/compteqc/cli/app.py
  - tests/test_documents.py
autonomous: true
requirements:
  - DOC-01
  - DOC-02
  - DOC-03
  - DOC-04

must_haves:
  truths:
    - "User can upload a receipt image or PDF via CLI and it is stored in ledger/documents/"
    - "AI extracts vendor, date, amount, and GST/QST breakdown from uploaded receipt"
    - "System proposes transaction matches based on amount and date proximity"
    - "Matched receipts generate Beancount document directives linking file to account"
    - "Low-quality images with confidence < 0.5 are flagged for manual entry"
  artifacts:
    - path: "src/compteqc/documents/extraction.py"
      provides: "Claude Vision receipt extraction with Pydantic structured output"
      contains: "extraire_recu"
    - path: "src/compteqc/documents/matching.py"
      provides: "Receipt-to-transaction matching with confidence scoring"
      contains: "proposer_correspondances"
    - path: "src/compteqc/documents/beancount_link.py"
      provides: "Beancount document directive generation"
      contains: "generer_directive_document"
    - path: "src/compteqc/cli/receipt.py"
      provides: "CLI commands for receipt upload and matching"
      contains: "receipt_app"
  key_links:
    - from: "src/compteqc/documents/extraction.py"
      to: "Anthropic API"
      via: "Claude Vision messages.parse() with Pydantic output_format"
      pattern: "messages\\.parse"
    - from: "src/compteqc/documents/matching.py"
      to: "Beancount ledger entries"
      via: "Compares extracted amount/date against existing transactions"
      pattern: "entries"
---

<objective>
Build the document ingestion pipeline for uploading receipts and invoices, extracting structured data via Claude Vision, matching to bank transactions, and linking in Beancount.

Purpose: Receipts are the source documents that prove expenses. This module lets the user upload physical receipt photos and digital PDFs, automatically extracts the key fields (vendor, date, amount, taxes), proposes matches to existing bank transactions, and creates audit trail links in the ledger.

Output: `documents/` module with upload, extraction, matching, and Beancount linking capabilities, plus CLI commands and tests.
</objective>

<execution_context>
@/Users/philippebeliveau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/philippebeliveau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-reporting-cpa-export-and-document-management/05-RESEARCH.md
@src/compteqc/categorisation/llm.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Receipt upload, AI extraction, and transaction matching</name>
  <files>
    src/compteqc/documents/__init__.py
    src/compteqc/documents/upload.py
    src/compteqc/documents/extraction.py
    src/compteqc/documents/matching.py
    src/compteqc/documents/beancount_link.py
  </files>
  <action>
    **Receipt data model** (in `documents/__init__.py` or extraction.py):
    - `DonneesRecu(BaseModel)`: fournisseur (str), date (str, YYYY-MM-DD), sous_total (Decimal), montant_tps (Decimal|None), montant_tvq (Decimal|None), total (Decimal), description (str), confiance (float 0.0-1.0).

    **Upload handler** (`documents/upload.py`):
    - `telecharger_recu(source_path: Path, ledger_dir: Path) -> Path`:
      - Validate file type: .jpg, .jpeg, .png, .pdf (reject others)
      - Resize images if > 1568px on longest edge (use Pillow) per Anthropic recommendation. Saves resized version.
      - Storage path: `ledger/documents/{YYYY}/{MM}/YYYY-MM-DD.{sanitized-vendor}.{ext}` (date from file creation or current date initially; renamed after extraction).
      - Copy file to storage path. Return stored path.
    - `renommer_recu(stored_path: Path, donnees: DonneesRecu) -> Path`:
      - Rename file using extracted data: `YYYY-MM-DD.{vendor-slug}.{ext}`
      - Returns new path.

    **Claude Vision extraction** (`documents/extraction.py`):
    - `extraire_recu(image_path: Path) -> DonneesRecu`:
      - Read file, base64 encode.
      - Determine media type from extension (.jpg/.jpeg -> image/jpeg, .png -> image/png, .pdf -> application/pdf).
      - Use `anthropic.Anthropic().messages.parse()` with `output_format=DonneesRecu` (same pattern as 03-02 ClassificateurLLM).
      - Prompt: "Extract from this receipt: vendor name, date (YYYY-MM-DD), subtotal before tax, GST amount (5%), QST amount (9.975%), total. If a tax is not visible, calculate from subtotal. If date not readable, use 'UNKNOWN'. Rate your confidence 0.0-1.0."
      - Model: `claude-sonnet-4-5-20250929` (cost-effective for extraction).
      - Lazy client initialization (same pattern as `categorisation/llm.py`).
      - If confidence < 0.5: log warning, mark as unreadable. Return result anyway (user can override).
    - Handle PDF: For PDFs, use document type content block. For images, use image type.

    **Transaction matching** (`documents/matching.py`):
    - `Correspondance(BaseModel)`: transaction_index (int), date (date), narration (str), montant (Decimal), score (float 0.0-1.0)
    - `proposer_correspondances(donnees: DonneesRecu, entries: list, seuil: float = 0.5) -> list[Correspondance]`:
      - Filter entries to transactions only (isinstance TxnPosting or Transaction).
      - For each transaction, compute match score:
        - Amount match: 1.0 if within $0.05, linear decay to 0.0 at $5.00 difference. Compare `donnees.total` against transaction amount (absolute value of first posting).
        - Date match: 1.0 if same day, 0.8 if within 1 day, linear decay to 0.0 at 7 days.
        - Combined score: 0.6 * amount_score + 0.4 * date_score.
      - Return matches with score >= seuil, sorted descending by score.
      - Auto-propose (per discretion): highlight matches with score >= 0.8 as "recommended".
    - Max 5 matches returned per receipt.

    **Beancount document linking** (`documents/beancount_link.py`):
    - `generer_directive_document(date: datetime.date, compte: str, chemin_fichier: str) -> str`:
      - Returns: `YYYY-MM-DD document Compte "documents/YYYY/MM/filename.ext"`
      - Path is relative to ledger root.
    - `ecrire_directive(directive: str, ledger_dir: Path, annee: int, mois: int)`:
      - Appends directive to the monthly .beancount file.

    **IMPORTANT patterns:**
    - Lazy Anthropic client (same as categorisation/llm.py) to avoid import-time API key requirement.
    - All amounts as Decimal, never float.
    - Git-tracked storage in `ledger/documents/` per discretion recommendation.
    - Resize before sending to Claude Vision to control cost and speed.
  </action>
  <verify>
    1. `uv run python -c "from compteqc.documents.upload import telecharger_recu; print('OK')"` succeeds
    2. `uv run python -c "from compteqc.documents.extraction import DonneesRecu; print('OK')"` succeeds
    3. `uv run python -c "from compteqc.documents.matching import proposer_correspondances; print('OK')"` succeeds
    4. `uv run python -c "from compteqc.documents.beancount_link import generer_directive_document; print('OK')"` succeeds
  </verify>
  <done>
    Upload handler validates file types and resizes images. Extraction uses Claude Vision with Pydantic output_format. Matching scores transactions by amount+date proximity. Document directive generator creates valid Beancount directives.
  </done>
</task>

<task type="auto">
  <name>Task 2: Receipt CLI commands and tests</name>
  <files>
    src/compteqc/cli/receipt.py
    src/compteqc/cli/app.py
    tests/test_documents.py
  </files>
  <action>
    **CLI subcommands** (`cli/receipt.py`):
    - `receipt_app = typer.Typer(name="recu", help="Gestion des recus et documents")`
    - Register in `cli/app.py` via `app.add_typer(receipt_app, name="recu")`.

    Commands:
    - `cqc recu telecharger <chemin>`:
      1. Upload file to ledger/documents/ (validates type, resizes images).
      2. Extract data via Claude Vision.
      3. Display extracted data in Rich table (fournisseur, date, sous-total, TPS, TVQ, total, confiance).
      4. If confidence < 0.5: show warning "Qualite insuffisante -- verifiez les donnees manuellement".
      5. Rename file with extracted vendor/date.
      6. Propose transaction matches from ledger (show top 3 with scores).
      7. Prompt user to select a match (number) or skip.
      8. If match selected: generate document directive and append to monthly file.
      9. Print stored file path and summary.
    - `cqc recu lister [--annee YYYY] [--mois MM]`:
      - List all documents in ledger/documents/ for given period.
      - Rich table: Fichier, Fournisseur (from filename), Date, Lie (yes/no based on document directive existence).
    - `cqc recu lier <chemin-fichier> <numero-transaction>`:
      - Manual linking: user provides document path and transaction identifier.
      - Generate document directive linking the file to the transaction's account.

    **Tests** (`tests/test_documents.py`):
    - `test_telecharger_recu_stores_file`: Upload copies file to correct directory structure
    - `test_telecharger_recu_rejects_invalid_type`: .exe file rejected with error
    - `test_telecharger_recu_resizes_large_image`: Image > 1568px is resized (use a test image created with Pillow)
    - `test_donnees_recu_model`: DonneesRecu validates correctly with Decimal amounts
    - `test_proposer_correspondances_exact_match`: Same amount + same date = score ~1.0
    - `test_proposer_correspondances_close_match`: Amount within $0.05, date within 1 day = high score
    - `test_proposer_correspondances_no_match`: Amount off by $50 = below threshold
    - `test_proposer_correspondances_max_five`: Never returns more than 5 matches
    - `test_generer_directive_document_format`: Output matches Beancount document directive syntax
    - `test_extraction_mock`: Mock Anthropic client, verify DonneesRecu parsing (do NOT call real API in tests)

    **Mock pattern for extraction tests:** Use `unittest.mock.patch` on `anthropic.Anthropic` to return a mock response. Same pattern as categorisation/llm.py tests. The matching and upload tests do NOT need mocking (pure logic).

    **Follow existing CLI patterns:** Typer sub-app, Rich tables, French labels, get_ledger_path().
  </action>
  <verify>
    `cd /Users/philippebeliveau/Desktop/Notebook/comptabilite && uv run pytest tests/test_documents.py -v` all tests pass
  </verify>
  <done>
    CLI commands registered under `cqc recu`. Upload, extraction (mocked), matching, and linking tested. At least 10 tests pass. French labels throughout.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_documents.py -v` -- all tests green
2. `uv run python -m compteqc.cli.app recu --help` -- shows telecharger, lister, lier subcommands
3. Matching logic verified: exact amount+date match produces score > 0.9
</verification>

<success_criteria>
- Receipt upload validates file types and resizes large images
- Claude Vision extraction returns structured DonneesRecu with confidence score
- Transaction matching scores by amount (60%) + date (40%) proximity
- Document directives follow Beancount syntax exactly
- Low-confidence receipts (< 0.5) flagged with warning
- CLI supports upload-extract-match-link workflow
- At least 10 tests pass (extraction mocked, matching tested with real logic)
</success_criteria>

<output>
After completion, create `.planning/phases/05-reporting-cpa-export-and-document-management/05-04-SUMMARY.md`
</output>
