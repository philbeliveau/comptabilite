---
phase: 05-reporting-cpa-export-and-document-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/compteqc/factures/__init__.py
  - src/compteqc/factures/modeles.py
  - src/compteqc/factures/registre.py
  - src/compteqc/factures/generateur.py
  - src/compteqc/factures/journal.py
  - src/compteqc/factures/templates/facture.html
  - src/compteqc/factures/templates/css/facture.css
  - src/compteqc/cli/facture.py
  - src/compteqc/cli/app.py
  - tests/test_factures.py
autonomous: true
requirements:
  - INV-01
  - INV-02
  - INV-03

must_haves:
  truths:
    - "User can create a draft invoice with line items and correct GST/QST calculation"
    - "Invoice renders to branded PDF with company logo placeholder, GST/QST numbers, and tax breakdown"
    - "User can mark invoice as sent, paid, or overdue via CLI"
    - "Creating an invoice generates a Beancount AR transaction (Actifs:ComptesClients)"
    - "Marking invoice as paid generates a payment Beancount transaction"
  artifacts:
    - path: "src/compteqc/factures/modeles.py"
      provides: "Invoice and InvoiceLine Pydantic models with tax calculation"
      contains: "class Invoice"
    - path: "src/compteqc/factures/registre.py"
      provides: "YAML-based invoice persistence"
      contains: "class RegistreFactures"
    - path: "src/compteqc/factures/journal.py"
      provides: "Beancount AR entry generation for invoices"
      contains: "generer_ecriture_facture"
    - path: "src/compteqc/cli/facture.py"
      provides: "CLI subcommands for invoice management"
      contains: "facture_app"
  key_links:
    - from: "src/compteqc/factures/journal.py"
      to: "Beancount ledger"
      via: "Generates AR transaction with Actifs:ComptesClients posting"
      pattern: "Actifs:ComptesClients"
    - from: "src/compteqc/cli/facture.py"
      to: "src/compteqc/factures/registre.py"
      via: "CLI reads/writes invoice registry"
      pattern: "RegistreFactures"
---

<objective>
Build the invoice generation system for consulting clients with branded PDF output, GST/QST tax calculation, payment status tracking, and accounts receivable ledger integration.

Purpose: Replaces the user's manual Word/Google Docs invoicing with a CLI-driven system that produces professional invoices, tracks payment status, and automatically creates Beancount journal entries for accounts receivable.

Output: `factures/` module with data models, YAML registry, PDF generator, Beancount journal integration, CLI commands, and tests.
</objective>

<execution_context>
@/Users/philippebeliveau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/philippebeliveau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-reporting-cpa-export-and-document-management/05-RESEARCH.md
@src/compteqc/cli/app.py
@ledger/comptes.beancount
</context>

<tasks>

<task type="auto">
  <name>Task 1: Invoice data model, registry, PDF generator, and Beancount integration</name>
  <files>
    src/compteqc/factures/__init__.py
    src/compteqc/factures/modeles.py
    src/compteqc/factures/registre.py
    src/compteqc/factures/generateur.py
    src/compteqc/factures/journal.py
    src/compteqc/factures/templates/facture.html
    src/compteqc/factures/templates/css/facture.css
  </files>
  <action>
    **Invoice data model** (`factures/modeles.py`):
    - `InvoiceStatus(str, Enum)`: DRAFT, SENT, PAID, OVERDUE
    - `LigneFacture(BaseModel)`: description, quantite (Decimal), prix_unitaire (Decimal), tps_applicable (bool=True), tvq_applicable (bool=True). Property `sous_total -> Decimal`.
    - `Facture(BaseModel)`: numero (str, e.g. "FAC-2026-001"), nom_client, adresse_client, date (datetime.date), date_echeance (datetime.date), lignes (list[LigneFacture]), statut (InvoiceStatus=DRAFT), date_paiement (date|None), notes (str="").
    - Properties: `sous_total`, `tps` (5% on applicable lines), `tvq` (9.975% on applicable lines), `total` (sous_total + tps + tvq). All quantized to 0.01.
    - `ConfigFacturation(BaseModel)`: nom_entreprise, adresse, numero_tps (str), numero_tvq (str), logo_path (Path|None), couleur_primaire (str="#1a365d"), courriel, telephone. Loaded from `factures/config.yaml`.

    **Invoice registry** (`factures/registre.py`):
    - `RegistreFactures` class with YAML persistence.
    - Constructor takes `chemin: Path` (path to registry YAML file, default `ledger/factures/registre.yaml`).
    - `ajouter(facture: Facture)` -- saves to registry. Validates no duplicate numero.
    - `obtenir(numero: str) -> Facture | None`
    - `lister(statut: InvoiceStatus | None = None) -> list[Facture]`
    - `mettre_a_jour_statut(numero: str, statut: InvoiceStatus, date_paiement: date | None = None)` -- updates status.
    - `prochain_numero(annee: int) -> str` -- scans existing invoices for the year, returns next sequential number (e.g., "FAC-2026-003"). Zero-padded to 3 digits.
    - YAML format: list of invoice dicts. Use Pydantic `model_dump(mode="json")` for serialization.

    **PDF generator** (`factures/generateur.py`):
    - `generer_pdf(facture: Facture, config: ConfigFacturation, output_dir: Path) -> Path`
    - Uses Jinja2 + WeasyPrint (same pattern as rapports/base.py but with invoice-specific template).
    - Template shows: company info (logo placeholder, name, address, GST/QST numbers), client info, invoice number/date/due date, line items table (description, qty, unit price, subtotal), tax summary (subtotal, TPS 5%, TVQ 9.975%, total), payment terms, notes.

    **Invoice HTML template** (`factures/templates/facture.html`):
    - Professional branded layout. Two-column header: company info left, invoice details right.
    - Line items table with Description, Quantite, Prix unitaire, Sous-total columns.
    - Tax summary section: Sous-total, TPS (5%), TVQ (9.975%), TOTAL in bold.
    - Footer: "GST: {numero_tps} | QST: {numero_tvq}" -- legal requirement.
    - Payment terms and notes section.

    **Invoice CSS** (`factures/templates/css/facture.css`):
    - `@page { size: letter; margin: 2cm; }` for print.
    - Brand colors from config (primary color for headers/accents).
    - Logo placement (if provided). Professional typography.
    - Amount columns right-aligned with tabular-nums.

    **Beancount journal integration** (`factures/journal.py`):
    - `generer_ecriture_facture(facture: Facture) -> str`:
      Generates Beancount transaction for invoice creation:
      ```
      YYYY-MM-DD * "Facture FAC-2026-001 - ClientName"
        Actifs:ComptesClients  TOTAL CAD
        Revenus:Consultation  -SOUS_TOTAL CAD
        Passifs:TPS-Percue    -TPS CAD
        Passifs:TVQ-Percue    -TVQ CAD
      ```
    - `generer_ecriture_paiement(facture: Facture) -> str`:
      Generates Beancount transaction for payment receipt:
      ```
      YYYY-MM-DD * "Paiement facture FAC-2026-001 - ClientName"
        Actifs:Banque:RBC-Cheques  TOTAL CAD
        Actifs:ComptesClients     -TOTAL CAD
      ```
    - Both functions return Beancount-formatted strings. Amounts as Decimal strings.
    - Verify account names match existing chart of accounts (Actifs:ComptesClients must exist -- check comptes.beancount).

    **IMPORTANT:**
    - Low volume (1-2 clients/month) -- keep it simple. No database, just YAML.
    - Payment tracking is manual per user decision: user marks as paid.
    - GST/QST numbers on every invoice is a legal requirement.
    - Invoice numbers must be sequential with no gaps (legal requirement in Quebec).
  </action>
  <verify>
    1. `uv run python -c "from compteqc.factures.modeles import Facture, LigneFacture; print('Models OK')"` succeeds
    2. `uv run python -c "from compteqc.factures.registre import RegistreFactures; print('Registry OK')"` succeeds
    3. `uv run python -c "from compteqc.factures.journal import generer_ecriture_facture; print('Journal OK')"` succeeds
  </verify>
  <done>
    Invoice model correctly calculates GST 5% + QST 9.975% on applicable lines. Registry persists to YAML with sequential numbering. PDF generates with branded template including tax numbers. Beancount AR entries balance correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Invoice CLI commands and tests</name>
  <files>
    src/compteqc/cli/facture.py
    src/compteqc/cli/app.py
    tests/test_factures.py
  </files>
  <action>
    **CLI subcommands** (`cli/facture.py`):
    - Create `facture_app = typer.Typer(name="facture", help="Gestion des factures")` sub-app.
    - Register in `cli/app.py` via `app.add_typer(facture_app, name="facture")`.

    Commands:
    - `cqc facture creer` -- Interactive prompts for: client name, address, line items (description, qty, unit price), date, due date, notes. Shows preview with tax totals. Creates draft. Generates Beancount AR entry and appends to monthly file. Prints invoice number.
    - `cqc facture lister [--statut draft|sent|paid|overdue]` -- Rich table showing: Numero, Client, Date, Echeance, Total, Statut. Color-coded status.
    - `cqc facture voir <numero>` -- Detailed view of single invoice with all line items and tax breakdown.
    - `cqc facture pdf <numero>` -- Generate PDF for invoice. Output path printed.
    - `cqc facture envoyer <numero>` -- Mark as SENT (no actual email -- just status change). Updates registry.
    - `cqc facture payer <numero> [--date DATE]` -- Mark as PAID. Updates registry. Generates Beancount payment entry and appends to monthly file. Date defaults to today.
    - `cqc facture relances` -- Show overdue invoices (status SENT and past due date). Auto-updates status to OVERDUE for display.

    **Config loading:** Read `ConfigFacturation` from `ledger/factures/config.yaml`. If file doesn't exist, create with placeholder values and prompt user to fill in.

    **Tests** (`tests/test_factures.py`):
    - `test_facture_tax_calculation`: Verify GST/QST/total on known invoice
    - `test_facture_no_tax_line`: Line with tps_applicable=False skips GST
    - `test_registre_ajouter_et_obtenir`: Round-trip YAML persistence
    - `test_registre_prochain_numero`: Sequential numbering across years
    - `test_registre_no_duplicate`: Adding duplicate numero raises error
    - `test_generer_ecriture_facture_balanced`: AR entry debits == credits
    - `test_generer_ecriture_paiement_balanced`: Payment entry debits == credits
    - `test_generer_pdf_creates_file`: PDF output exists and starts with %PDF
    - `test_cli_facture_lister`: CLI lister command shows table (use CliRunner)
    - `test_statut_transitions`: draft->sent->paid lifecycle works

    **Follow existing CLI patterns:**
    - Use `get_ledger_path()` for ledger directory (same as other CLI modules)
    - Rich tables for output (same as rapports CLI)
    - French labels and error messages throughout
    - Tests use `tmp_path` for isolated YAML registry and ledger files
  </action>
  <verify>
    `cd /Users/philippebeliveau/Desktop/Notebook/comptabilite && uv run pytest tests/test_factures.py -v` all tests pass
  </verify>
  <done>
    All CLI commands registered under `cqc facture`. Invoice creation calculates taxes correctly. YAML persistence works. Beancount entries balance. PDF generates. At least 10 tests pass.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_factures.py -v` -- all tests green
2. `uv run python -m compteqc.cli.app facture --help` -- shows all subcommands
3. Verify invoice total: $10,000 consulting -> $10,000 + $500 TPS + $997.50 TVQ = $11,497.50
</verification>

<success_criteria>
- Invoice model correctly computes GST 5% and QST 9.975% separately
- PDF renders with company info, tax numbers, line items, and tax breakdown
- YAML registry persists invoices with sequential numbering
- CLI supports full lifecycle: create, list, view, pdf, send, pay
- Beancount AR entries generated on create, payment entries on pay
- At least 10 tests pass covering model, registry, journal, and CLI
</success_criteria>

<output>
After completion, create `.planning/phases/05-reporting-cpa-export-and-document-management/05-02-SUMMARY.md`
</output>
