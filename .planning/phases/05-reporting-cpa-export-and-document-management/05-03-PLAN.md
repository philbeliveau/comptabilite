---
phase: 05-reporting-cpa-export-and-document-management
plan: 03
type: execute
wave: 2
depends_on:
  - "05-01"
files_modified:
  - src/compteqc/rapports/sommaire_paie.py
  - src/compteqc/rapports/sommaire_dpa.py
  - src/compteqc/rapports/sommaire_taxes.py
  - src/compteqc/rapports/sommaire_pret.py
  - src/compteqc/rapports/cpa_package.py
  - src/compteqc/rapports/templates/sommaire_paie.html
  - src/compteqc/rapports/templates/sommaire_dpa.html
  - src/compteqc/rapports/templates/sommaire_taxes.html
  - src/compteqc/rapports/templates/sommaire_pret.html
  - src/compteqc/echeances/__init__.py
  - src/compteqc/echeances/verification.py
  - src/compteqc/cli/cpa.py
  - src/compteqc/cli/app.py
  - tests/test_cpa_package.py
autonomous: true
requirements:
  - CPA-04
  - CPA-05
  - CPA-06
  - CPA-07
  - AUTO-02
  - CLI-05

must_haves:
  truths:
    - "Payroll schedule shows gross, each deduction, employer contributions, and net for all pay periods"
    - "CCA schedule shows cost, half-year, CCA claimed, and UCC by asset class"
    - "GST/QST summary shows collected, ITCs/ITRs, and net remittance by period"
    - "Shareholder loan schedule shows all movements and s.15(2) deadlines"
    - "Year-end checklist validates all modules before CPA package generation"
    - "CLI command generates complete ZIP package with all reports"
  artifacts:
    - path: "src/compteqc/rapports/cpa_package.py"
      provides: "CPA package orchestrator generating all reports into ZIP"
      contains: "generer_package_cpa"
    - path: "src/compteqc/echeances/verification.py"
      provides: "Year-end checklist validation"
      contains: "verifier_fin_exercice"
    - path: "src/compteqc/cli/cpa.py"
      provides: "CLI command cqc cpa export"
      contains: "cpa_app"
  key_links:
    - from: "src/compteqc/rapports/sommaire_paie.py"
      to: "src/compteqc/quebec/paie/moteur.py"
      via: "Reads payroll results for schedule data"
      pattern: "from compteqc\\.quebec\\.paie"
    - from: "src/compteqc/rapports/cpa_package.py"
      to: "src/compteqc/rapports/base.py"
      via: "Orchestrates all BaseReport subclasses"
      pattern: "from compteqc\\.rapports"
    - from: "src/compteqc/echeances/verification.py"
      to: "src/compteqc/rapports/gifi_export.py"
      via: "Runs GIFI validation as part of year-end checks"
      pattern: "validate_gifi"
---

<objective>
Build the four specialized CPA schedules (payroll, CCA, GST/QST, shareholder loan), the year-end verification checklist, and the CPA package orchestrator CLI that bundles everything into a ZIP.

Purpose: This completes the CPA export capability. Combined with the financial statements from 05-01, this gives the user the ability to run `cqc cpa export --annee 2025` and produce a single ZIP with everything the CPA needs.

Output: Four schedule generators, year-end checklist module, CPA package orchestrator, CLI command, and tests.
</objective>

<execution_context>
@/Users/philippebeliveau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/philippebeliveau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-reporting-cpa-export-and-document-management/05-RESEARCH.md
@.planning/phases/05-reporting-cpa-export-and-document-management/05-01-SUMMARY.md
@src/compteqc/rapports/base.py
@src/compteqc/quebec/paie/moteur.py
@src/compteqc/quebec/dpa/calcul.py
@src/compteqc/quebec/taxes/sommaire.py
@src/compteqc/quebec/pret_actionnaire/suivi.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Four specialized CPA schedules as BaseReport subclasses</name>
  <files>
    src/compteqc/rapports/sommaire_paie.py
    src/compteqc/rapports/sommaire_dpa.py
    src/compteqc/rapports/sommaire_taxes.py
    src/compteqc/rapports/sommaire_pret.py
    src/compteqc/rapports/templates/sommaire_paie.html
    src/compteqc/rapports/templates/sommaire_dpa.html
    src/compteqc/rapports/templates/sommaire_taxes.html
    src/compteqc/rapports/templates/sommaire_pret.html
  </files>
  <action>
    All four schedules subclass `BaseReport` from 05-01. Each calls existing Phase 2 domain modules for data extraction, then formats into PDF+CSV.

    **Sommaire de paie** (`rapports/sommaire_paie.py`, CPA-04):
    - `report_name = "sommaire_paie"`, `template_name = "sommaire_paie.html"`
    - `extract_data()`: Read payroll entries from ledger (filter transactions with tag "paie" for the fiscal year). Extract from each: date, gross pay, each deduction type (QPP base, QPP supp, RQAP, EI, fed tax, QC tax), employer contributions (QPP, RQAP, EI, FSS, CNESST, normes), net pay.
    - Use the per-deduction liability sub-account balances (Phase 2 decision) to get totals.
    - Table: One row per pay period. Columns: Date, Brut, QPP, RQAP, AE, Impot Fed, Impot QC, Net, Cotis Employeur.
    - Summary row at bottom with annual totals.
    - CSV gets all rows + totals. PDF-only (per research recommendation -- CPAs rarely import payroll into tax software).
    - OVERRIDE: Generate CSV too for payroll (user locked "CSV for key data exports" including payroll schedule).

    **Sommaire DPA** (`rapports/sommaire_dpa.py`, CPA-05):
    - `report_name = "sommaire_dpa"`, `template_name = "sommaire_dpa.html"`
    - `extract_data()`: Use `dpa/calcul.py` pool calculation and `dpa/registre.py` asset list.
    - Table per CCA class: Class, FNACC debut, Acquisitions, Dispositions, Regle demi-annee, DPA reclamee, FNACC fin.
    - Asset detail sub-table per class: Description, Date acquisition, Cout.
    - PDF only (CCA schedules are informational for CPA review, not imported). But include CSV for completeness.

    **Sommaire TPS/TVQ** (`rapports/sommaire_taxes.py`, CPA-06):
    - `report_name = "sommaire_taxes"`, `template_name = "sommaire_taxes.html"`
    - `extract_data()`: Use `taxes/sommaire.py:SommairePeriode` for quarterly data.
    - Table per filing period (Q1-Q4): Periode, TPS percue, CTI (TPS payee), TPS nette, TVQ percue, RTI (TVQ payee), TVQ nette.
    - Annual summary row.
    - CSV export (CPA needs this for GST/QST return prep).

    **Sommaire pret actionnaire** (`rapports/sommaire_pret.py`, CPA-07):
    - `report_name = "sommaire_pret"`, `template_name = "sommaire_pret.html"`
    - `extract_data()`: Use `pret_actionnaire/suivi.py:EtatPret` or `obtenir_etat_pret()`.
    - Continuity schedule: Date, Description, Avances, Remboursements, Solde.
    - s.15(2) deadline section: each outstanding advance with its inclusion date and status (within threshold? past due?).
    - Year-end balance clearly shown.
    - PDF only (shareholder loan schedule is review material).

    **Template patterns:** All four templates extend `base_report.html`. Use same CSS classes. Tables use `amount` class for right-aligned numeric columns. Total rows use `total` class.

    **IMPORTANT:** Each schedule calls existing Phase 2 functions for data. Do NOT re-implement payroll math, CCA calculation, tax summaries, or loan tracking. These are FORMATTING modules.
  </action>
  <verify>
    1. `uv run python -c "from compteqc.rapports.sommaire_paie import SommairePaie; print('OK')"` succeeds
    2. `uv run python -c "from compteqc.rapports.sommaire_dpa import SommaireDPA; print('OK')"` succeeds
    3. `uv run python -c "from compteqc.rapports.sommaire_taxes import SommaireTaxes; print('OK')"` succeeds
    4. `uv run python -c "from compteqc.rapports.sommaire_pret import SommairePret; print('OK')"` succeeds
  </verify>
  <done>
    Four schedule generators exist as BaseReport subclasses. Each reads from Phase 2 domain modules. Templates extend base_report.html. CSV and PDF output methods work.
  </done>
</task>

<task type="auto">
  <name>Task 2: CPA package orchestrator, year-end checklist, CLI, and tests</name>
  <files>
    src/compteqc/rapports/cpa_package.py
    src/compteqc/echeances/__init__.py
    src/compteqc/echeances/verification.py
    src/compteqc/cli/cpa.py
    src/compteqc/cli/app.py
    tests/test_cpa_package.py
  </files>
  <action>
    **Year-end checklist** (`echeances/verification.py`):
    - `VerificationResult(BaseModel)`: nom (str), passe (bool), message (str), severite ("info"|"warning"|"error")
    - `verifier_fin_exercice(entries, annee, fin_exercice) -> list[VerificationResult]`:
      Runs all checks and returns results. Checks:
      1. GIFI validation (accounting equation balance) -- calls `validate_gifi()` from 05-01. Severity: error if unbalanced.
      2. Shareholder loan balance: warn if non-zero at year-end (CPA should review s.15(2) implications).
      3. CCA schedule consistency: verify sum of FNACC across pools matches Actifs:Immobilisations balance. Severity: warning if mismatch.
      4. GST/QST reconciliation: verify TPS/TVQ collected minus ITCs/ITRs matches Passifs:TPS-Nette/TVQ-Nette balances. Severity: warning if mismatch.
      5. Unclassified transactions: count transactions with Depenses:Non-Classe. Severity: warning if any remain.
      6. Pending transactions: count entries in pending.beancount. Severity: warning if any unapproved.
    - Warn-but-allow per discretion recommendation: checklist displays pass/fail/warning but does NOT block CPA package generation. Only block on fatal errors (accounting equation).

    **CPA Package orchestrator** (`rapports/cpa_package.py`):
    - `generer_package_cpa(entries, annee, fin_exercice, output_dir, entreprise="") -> Path`:
      1. Run year-end checklist. Display results to console (Rich table: check name, status, message).
      2. If fatal errors exist (accounting equation), abort with error message.
      3. Generate all reports into `output_dir/cpa-package-{annee}/`:
         - `rapports/` subfolder: balance_verification (CSV+PDF), etat_resultats (CSV+PDF), bilan (CSV+PDF)
         - `annexes/` subfolder: sommaire_paie (CSV+PDF), sommaire_dpa (PDF), sommaire_taxes (CSV+PDF), sommaire_pret (PDF)
         - `gifi/` subfolder: gifi_s100.csv, gifi_s125.csv
      4. ZIP everything: `output_dir/cpa-package-{annee}.zip` using `zipfile.ZIP_DEFLATED`.
      5. Return path to ZIP.

    **CLI** (`cli/cpa.py`):
    - `cpa_app = typer.Typer(name="cpa", help="Export CPA et rapports")`
    - Register in `cli/app.py` via `app.add_typer(cpa_app, name="cpa")`.
    - `cqc cpa export --annee YYYY [--sortie PATH]`:
      - Loads ledger entries for the year.
      - Calls `generer_package_cpa()`.
      - Shows checklist results as Rich table.
      - Shows list of generated files.
      - Prints ZIP path.
      - Default output to `ledger/exports/`.
    - `cqc cpa verifier --annee YYYY`:
      - Runs year-end checklist only (no report generation).
      - Displays results as Rich table with color-coded pass/fail/warning.

    **Tests** (`tests/test_cpa_package.py`):
    - `test_verification_balanced_passes`: All checks pass on well-formed test ledger
    - `test_verification_unbalanced_fails`: GIFI check returns error on imbalanced ledger
    - `test_verification_unclassified_warns`: Warning when Non-Classe transactions exist
    - `test_verification_pending_warns`: Warning when pending.beancount has entries
    - `test_generer_package_creates_zip`: ZIP file created with expected structure
    - `test_generer_package_zip_contents`: ZIP contains rapports/, annexes/, gifi/ subdirs
    - `test_generer_package_aborts_on_fatal`: Raises or returns error when accounting equation fails
    - `test_cli_cpa_export`: CLI command produces ZIP (use CliRunner with test ledger)
    - `test_cli_cpa_verifier`: CLI command shows checklist table

    **Follow existing CLI patterns:** Typer sub-app, Rich tables, French labels, get_ledger_path().
  </action>
  <verify>
    `cd /Users/philippebeliveau/Desktop/Notebook/comptabilite && uv run pytest tests/test_cpa_package.py -v` all tests pass
  </verify>
  <done>
    Year-end checklist runs 6 validation checks with warn-but-allow behavior. CPA package generates ZIP with all reports organized into subdirectories. CLI `cqc cpa export` produces the complete package. CLI `cqc cpa verifier` shows checklist only. At least 8 tests pass.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_cpa_package.py -v` -- all tests green
2. `uv run python -m compteqc.cli.app cpa --help` -- shows export and verifier subcommands
3. ZIP structure check: `python -c "import zipfile; z=zipfile.ZipFile('path/to/zip'); print(z.namelist())"` shows rapports/, annexes/, gifi/ dirs
</verification>

<success_criteria>
- Four schedule reports generate correctly using Phase 2 domain module data
- Year-end checklist validates 6 areas with appropriate severity levels
- CPA package ZIP contains all reports in organized subdirectories
- Fatal errors (equation imbalance) block package generation
- Warnings (non-zero shareholder loan, unclassified txns) display but allow generation
- CLI `cqc cpa export` produces the complete package with progress output
- At least 8 tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-reporting-cpa-export-and-document-management/05-03-SUMMARY.md`
</output>
