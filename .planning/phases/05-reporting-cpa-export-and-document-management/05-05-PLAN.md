---
phase: 05-reporting-cpa-export-and-document-management
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/compteqc/echeances/calendrier.py
  - src/compteqc/echeances/remises.py
  - src/compteqc/cli/app.py
  - tests/test_echeances.py
autonomous: true
requirements:
  - AUTO-01
  - AUTO-03

must_haves:
  truths:
    - "System calculates correct filing deadlines based on fiscal year-end date"
    - "Deadline alerts show at appropriate lead times (90/60/30/14/7 days)"
    - "Payroll remittance tracking shows amounts owed vs remitted"
    - "Shareholder loan s.15(2) deadlines appear in the same calendar"
    - "CLI output shows active deadline reminders when within 30 days"
  artifacts:
    - path: "src/compteqc/echeances/calendrier.py"
      provides: "Deadline calendar with calculation and alert logic"
      contains: "calculer_echeances"
    - path: "src/compteqc/echeances/remises.py"
      provides: "Payroll remittance tracking (owed vs remitted)"
      contains: "suivi_remises"
  key_links:
    - from: "src/compteqc/echeances/calendrier.py"
      to: "src/compteqc/quebec/pret_actionnaire/suivi.py"
      via: "Integrates s.15(2) deadlines into unified calendar"
      pattern: "pret_actionnaire"
    - from: "src/compteqc/echeances/remises.py"
      to: "Beancount ledger entries"
      via: "Reads Passifs:Retenues and Passifs:Cotisations sub-accounts"
      pattern: "Passifs:Retenues"
---

<objective>
Build the filing deadline calendar with alert system and payroll remittance tracking.

Purpose: Deadlines are the single most dangerous thing for a solo consultant to miss. Late T2 filing means penalties. Late payroll remittances mean interest. This module calculates all deadlines, tracks proximity, and surfaces alerts in CLI output so the user never misses a filing date.

Output: `echeances/` module with deadline calendar, remittance tracker, CLI integration, and tests.
</objective>

<execution_context>
@/Users/philippebeliveau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/philippebeliveau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-reporting-cpa-export-and-document-management/05-RESEARCH.md
@src/compteqc/quebec/pret_actionnaire/suivi.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Filing deadline calendar and payroll remittance tracking</name>
  <files>
    src/compteqc/echeances/__init__.py
    src/compteqc/echeances/calendrier.py
    src/compteqc/echeances/remises.py
  </files>
  <action>
    **Note:** `echeances/__init__.py` may already exist from 05-03 (verification.py). If so, just add imports. If 05-05 runs before 05-03 (parallel Wave 1), create the __init__.py.

    **Deadline types and model** (`echeances/calendrier.py`):
    - `TypeEcheance(str, Enum)`: T4_RL1, TPS_TVQ, T2, CO17, PRET_ACTIONNAIRE, REMISE_PAIE
    - `Echeance(BaseModel)`: type (TypeEcheance), date_limite (datetime.date), description (str), jours_alerte (list[int]), completed (bool = False)
    - `AlerteEcheance(BaseModel)`: echeance (Echeance), jours_restants (int), urgence ("critique"|"urgent"|"normal"|"info")

    **Deadline calculator** (`echeances/calendrier.py`):
    - `calculer_echeances(fin_exercice: datetime.date) -> list[Echeance]`:
      Based on research examples. Calculates:
      1. **T4/RL-1**: Feb 28 following calendar year (if weekend, next business day). Alert: 90, 60, 30, 14, 7 days.
      2. **T2**: 6 months after fiscal year-end (`relativedelta(months=6)`). Alert: 90, 60, 30, 14, 7 days.
      3. **CO-17**: Same date as T2. Alert: 90, 60, 30, 14, 7 days.
      4. **GST/QST quarterly**: For each quarter end (Mar 31, Jun 30, Sep 30, Dec 31), due 1 month later. Alert: 30, 14, 7 days.
      5. **Payroll remittances**: 15th of month following each pay period (for regular remitters). Alert: 14, 7, 3 days.
    - `integrer_echeances_pret(echeances: list[Echeance], etat_pret) -> list[Echeance]`:
      - Takes shareholder loan state from `pret_actionnaire/suivi.py`.
      - For each outstanding advance with a s.15(2) deadline, add an Echeance with type PRET_ACTIONNAIRE. Alert: 90, 60, 30, 14, 7 days (high stakes).
      - This unifies shareholder loan deadlines into the same calendar per user decision.
    - `obtenir_alertes(echeances: list[Echeance], aujourd_hui: datetime.date = None) -> list[AlerteEcheance]`:
      - For each echeance, check if today is within any alert window.
      - Urgence levels: critique (<= 7 days), urgent (<= 14 days), normal (<= 30 days), info (<= 90 days).
      - Filter to only active alerts (within alert window and not completed).
      - Sort by jours_restants ascending (most urgent first).
    - `formater_rappels_cli(alertes: list[AlerteEcheance]) -> str | None`:
      - Returns a formatted string for display at bottom of CLI output.
      - Only shows alerts within 30 days per discretion recommendation.
      - Format: "[!] Rappel: TPS/TVQ Q4 dans 14 jours (2026-01-31)"
      - Returns None if no active alerts within 30 days.
      - Color-coded via Rich markup: red for critique, yellow for urgent, blue for normal.

    **Payroll remittance tracking** (`echeances/remises.py`):
    - `RemisePaie(BaseModel)`: mois (int), annee (int), retenues_dues (Decimal), cotisations_dues (Decimal), total_du (Decimal), total_remis (Decimal), solde (Decimal)
    - `suivi_remises(entries: list, annee: int) -> list[RemisePaie]`:
      - For each month of the year:
        - Sum all postings to Passifs:Retenues:* sub-accounts (employee deductions owed).
        - Sum all postings to Passifs:Cotisations-Employeur:* sub-accounts (employer contributions owed).
        - Sum all remittance transactions (payments to CRA/RQ -- look for transactions that debit Passifs:Retenues or Passifs:Cotisations-Employeur and credit Actifs:Banque).
        - Calculate solde = total_du - total_remis.
      - Return list of 12 RemisePaie (one per month).
    - `prochaine_remise(remises: list[RemisePaie], aujourd_hui: date) -> Echeance | None`:
      - Find most recent month with non-zero solde.
      - Return deadline (15th of following month).

    **IMPORTANT:**
    - Use `python-dateutil.relativedelta` for month arithmetic (already installed).
    - Weekend adjustment for deadlines: if deadline falls on Saturday, push to Monday. If Sunday, push to Monday.
    - All dates computed from `fin_exercice` parameter, NOT hardcoded to Dec 31 (per anti-pattern warning in research).
    - Payroll remittance frequency: assume "regular remitter" (15th of following month). Threshold remitter and quarterly remitter are edge cases for future.
  </action>
  <verify>
    1. `uv run python -c "from compteqc.echeances.calendrier import calculer_echeances; print(len(calculer_echeances(__import__('datetime').date(2025,12,31))))"` prints a number >= 8
    2. `uv run python -c "from compteqc.echeances.remises import suivi_remises; print('OK')"` succeeds
  </verify>
  <done>
    Deadline calculator produces correct dates for all filing types. Weekend adjustment works. Shareholder loan deadlines integrate into calendar. Alert urgency levels classify correctly. Remittance tracker computes owed vs remitted by month.
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI integration for deadlines and tests</name>
  <files>
    src/compteqc/cli/app.py
    tests/test_echeances.py
  </files>
  <action>
    **CLI integration** (modify `cli/app.py`):
    - Add `cqc echeances` subcommand group (or add to existing app if echeances already has a typer sub-app):
      - `cqc echeances calendrier [--annee YYYY]`: Show all deadlines for fiscal year as Rich table. Columns: Type, Date limite, Description, Jours restants, Urgence. Color-coded by urgence.
      - `cqc echeances remises [--annee YYYY]`: Show payroll remittance status by month. Columns: Mois, Retenues dues, Cotisations dues, Total du, Total remis, Solde. Highlight non-zero soldes.
      - `cqc echeances rappels`: Show only active alerts within 30 days (same as what would appear in CLI footer).

    **CLI footer integration:**
    - In the main `app.py` callback (or a result_callback), after any command completes, call `formater_rappels_cli()` and print the result if not None.
    - Per discretion: "show active deadline reminders in CLI output when any deadline is within 30 days."
    - This is lightweight -- load ledger, compute deadlines, check alerts. If ledger not accessible (e.g., --help), skip silently.
    - Implementation: use Typer `@app.callback(result_callback=True)` or append to each command's output. Simplest approach: a helper function called at end of main commands that checks for alerts and prints them.

    **Tests** (`tests/test_echeances.py`):
    - `test_calculer_echeances_dec31`: For Dec 31 year-end, T2 due Jun 30, T4 due Feb 28
    - `test_calculer_echeances_mar31`: For Mar 31 year-end, T2 due Sep 30
    - `test_weekend_adjustment`: Deadline on Saturday -> Monday
    - `test_gst_qst_quarterly_deadlines`: 4 quarterly deadlines with correct due dates
    - `test_obtenir_alertes_within_window`: Alert returned when within alert days
    - `test_obtenir_alertes_outside_window`: No alert when deadline > 90 days away
    - `test_urgence_critique`: <= 7 days = critique
    - `test_urgence_urgent`: 8-14 days = urgent
    - `test_urgence_normal`: 15-30 days = normal
    - `test_integrer_echeances_pret`: Shareholder loan deadline appears in calendar
    - `test_suivi_remises_no_entries`: Empty ledger returns 12 months with zero balances
    - `test_suivi_remises_with_payroll`: Month with payroll shows non-zero retenues_dues
    - `test_formater_rappels_cli_none_outside_30`: Returns None when no alerts within 30 days
    - `test_formater_rappels_cli_shows_urgent`: Returns formatted string when alert within 14 days

    **Use freezegun for date-dependent tests** (already a project dependency). Freeze `datetime.date.today()` to control "today" in alert tests.
  </action>
  <verify>
    `cd /Users/philippebeliveau/Desktop/Notebook/comptabilite && uv run pytest tests/test_echeances.py -v` all tests pass
  </verify>
  <done>
    CLI shows deadline calendar, remittance status, and active alerts. Footer integration shows reminders on any cqc command when deadlines within 30 days. At least 12 tests pass covering all deadline types, urgency levels, weekend adjustment, and remittance tracking.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_echeances.py -v` -- all tests green
2. `uv run python -m compteqc.cli.app echeances --help` -- shows calendrier, remises, rappels subcommands
3. Deadline math: Dec 31 year-end -> T2 due Jun 30, T4 due Feb 28, Q4 GST due Jan 31
</verification>

<success_criteria>
- All filing deadline types calculated correctly from fiscal year-end date
- Weekend adjustment pushes Saturday/Sunday to Monday
- Alert urgency levels match: critique <= 7d, urgent <= 14d, normal <= 30d
- Shareholder loan deadlines unified in same calendar
- Payroll remittance tracking shows owed vs remitted by month
- CLI footer shows active alerts when within 30 days
- At least 12 tests pass with freezegun for date control
</success_criteria>

<output>
After completion, create `.planning/phases/05-reporting-cpa-export-and-document-management/05-05-SUMMARY.md`
</output>
