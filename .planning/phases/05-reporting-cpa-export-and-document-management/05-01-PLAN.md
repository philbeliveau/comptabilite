---
phase: 05-reporting-cpa-export-and-document-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/compteqc/rapports/__init__.py
  - src/compteqc/rapports/base.py
  - src/compteqc/rapports/balance_verification.py
  - src/compteqc/rapports/etat_resultats.py
  - src/compteqc/rapports/bilan.py
  - src/compteqc/rapports/gifi_export.py
  - src/compteqc/rapports/templates/base_report.html
  - src/compteqc/rapports/templates/balance_verification.html
  - src/compteqc/rapports/templates/etat_resultats.html
  - src/compteqc/rapports/templates/bilan.html
  - src/compteqc/rapports/templates/css/report.css
  - tests/test_rapports.py
autonomous: true
requirements:
  - CPA-01
  - CPA-02
  - CPA-03
  - CPA-08
  - CPA-09

must_haves:
  truths:
    - "Trial balance renders to both CSV and PDF with correct totals matching ledger"
    - "Income statement renders to both CSV and PDF with correct revenue minus expenses"
    - "Balance sheet renders to both CSV and PDF with accounting equation balanced"
    - "GIFI validation catches accounting equation imbalance before export"
    - "GIFI CSV export aggregates multiple accounts to same GIFI code correctly"
  artifacts:
    - path: "src/compteqc/rapports/base.py"
      provides: "BaseReport with Jinja2+WeasyPrint dual output"
      contains: "class BaseReport"
    - path: "src/compteqc/rapports/gifi_export.py"
      provides: "GIFI validation and CSV export"
      contains: "validate_gifi"
    - path: "src/compteqc/rapports/templates/css/report.css"
      provides: "Shared report styling with @page rules"
      contains: "@page"
  key_links:
    - from: "src/compteqc/rapports/balance_verification.py"
      to: "src/compteqc/ledger/rapports.py"
      via: "Calls existing balance() function for data extraction"
      pattern: "from compteqc\\.ledger\\.rapports import"
    - from: "src/compteqc/rapports/gifi_export.py"
      to: "ledger/comptes.beancount"
      via: "Reads GIFI metadata from account open directives"
      pattern: "gifi"
---

<objective>
Build the CPA report generation engine with dual-output (CSV + PDF) for the three core financial statements (trial balance, income statement, balance sheet) plus GIFI validation and export.

Purpose: This is the presentation layer foundation. All existing data extraction logic lives in `ledger/rapports.py` (balance, resultats, bilan functions). This plan wraps that data in professional PDF templates and machine-readable CSV, and adds GIFI code validation/export for TaxCycle import.

Output: `rapports/` module with BaseReport class, 3 financial statement generators, GIFI validator/exporter, Jinja2 HTML templates, print CSS, and tests.
</objective>

<execution_context>
@/Users/philippebeliveau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/philippebeliveau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-reporting-cpa-export-and-document-management/05-RESEARCH.md
@.planning/phases/01-ledger-foundation-and-import-pipeline/01-03-SUMMARY.md
@src/compteqc/ledger/rapports.py
@ledger/comptes.beancount
</context>

<tasks>

<task type="auto">
  <name>Task 1: Report engine infrastructure and three financial statement generators</name>
  <files>
    src/compteqc/rapports/__init__.py
    src/compteqc/rapports/base.py
    src/compteqc/rapports/balance_verification.py
    src/compteqc/rapports/etat_resultats.py
    src/compteqc/rapports/bilan.py
    src/compteqc/rapports/gifi_export.py
    src/compteqc/rapports/templates/base_report.html
    src/compteqc/rapports/templates/balance_verification.html
    src/compteqc/rapports/templates/etat_resultats.html
    src/compteqc/rapports/templates/bilan.html
    src/compteqc/rapports/templates/css/report.css
  </files>
  <action>
    **Install WeasyPrint:** Run `uv add weasyprint pillow`. WeasyPrint requires system libs -- on macOS `brew install pango` if not already present.

    **BaseReport class** (`rapports/base.py`):
    - Jinja2 Environment with `PackageLoader("compteqc.rapports", "templates")`
    - Constructor takes `entries: list, annee: int, entreprise: str = ""`
    - `extract_data() -> dict` abstract method for subclasses
    - `to_csv(output_path: Path) -> Path` writes CSV using `csv.writer`. Always `quantize(Decimal("0.01"))` before writing amounts. Subclasses override `csv_rows() -> list[list]` and `csv_headers() -> list[str]`.
    - `to_pdf(output_path: Path) -> Path` renders template via Jinja2, converts to PDF via `HTML(string=html).write_pdf(str(output_path), stylesheets=[str(css_path)])`.
    - `generate(output_dir: Path) -> dict[str, Path]` calls both to_csv and to_pdf.

    **CSS** (`templates/css/report.css`):
    - `@page { size: letter; margin: 2cm; }` with header (company name) and footer (page numbers)
    - Professional styling: Helvetica Neue/Arial, tabular-nums for amounts, right-aligned amount columns
    - Total rows bold with top border
    - Print-friendly: no background colors that waste ink

    **Base HTML template** (`templates/base_report.html`):
    - Jinja2 template inheritance base with blocks: `title`, `subtitle`, `content`
    - Company name, fiscal year, generation date in header
    - "Generated by CompteQC" footer

    **Balance de verification** (`rapports/balance_verification.py`):
    - Subclass of BaseReport. `report_name = "balance_verification"`, `template_name = "balance_verification.html"`
    - `extract_data()`: Call existing `rapports.balance(entries)` from `compteqc.ledger.rapports`. Transform its output into template context with columns: Compte, GIFI, Debit, Credit.
    - Include GIFI code for each account (read from account open directive metadata).
    - Total row at bottom. Verify debit total == credit total.
    - CSV headers: `Compte,GIFI,Debit,Credit`

    **Etat des resultats** (`rapports/etat_resultats.py`):
    - Subclass of BaseReport. Uses existing `rapports.resultats(entries)`.
    - Sections: Revenus, Depenses (by category), Resultat net.
    - CSV headers: `Compte,GIFI,Montant`

    **Bilan** (`rapports/bilan.py`):
    - Subclass of BaseReport. Uses existing `rapports.bilan(entries)`.
    - Sections: Actifs, Passifs, Capitaux propres (includes resultat net).
    - Accounting equation verification in extract_data (Assets = Liabilities + Equity).
    - CSV headers: `Compte,GIFI,Montant`

    **GIFI Export** (`rapports/gifi_export.py`):
    - `GIFIValidationResult` dataclass: balanced, total_assets, total_liabilities, total_equity, warnings, errors
    - `validate_gifi(soldes, gifi_map) -> GIFIValidationResult`:
      - Check accounting equation: Assets = Liabilities + Equity + Net Income
      - Check no negative revenue accounts (warning)
      - Check asset totals positive (warning)
      - BLOCK export if accounting equation does not balance (error)
    - `extract_gifi_map(entries) -> dict[str, str]`: Parse account open directives to get account->GIFI mapping
    - `aggregate_by_gifi(soldes, gifi_map) -> dict[str, Decimal]`: Sum balances by GIFI code (multiple accounts may map to same GIFI)
    - `export_gifi_csv(gifi_balances, output_path, schedule="S100") -> Path`: Write GIFI_CODE,AMOUNT CSV. Skip zero balances. Amounts quantized to 0.01.
    - Test that sum of GIFI-aggregated amounts equals trial balance total.

    **IMPORTANT patterns to follow:**
    - All monetary values are Decimal, never float. Use `quantize(Decimal("0.01"))` for output.
    - Read GIFI codes from existing `comptes.beancount` metadata (accounts already have GIFI metadata from Phase 1).
    - Reuse existing `rapports.balance()`, `rapports.resultats()`, `rapports.bilan()` for data extraction. Do NOT re-implement balance computation.
    - French naming for report titles: "Balance de verification", "Etat des resultats", "Bilan"
  </action>
  <verify>
    1. `uv run python -c "from compteqc.rapports.base import BaseReport; print('OK')"` succeeds
    2. `uv run python -c "from compteqc.rapports.gifi_export import validate_gifi, export_gifi_csv; print('OK')"` succeeds
    3. `uv run python -c "from weasyprint import HTML; print('WeasyPrint OK')"` succeeds
  </verify>
  <done>
    BaseReport class exists with to_csv/to_pdf/generate methods. Three financial statement report classes exist with extract_data/csv_rows/csv_headers. GIFI validator catches equation imbalance. GIFI CSV exporter aggregates by code. All templates render valid HTML. CSS has @page rules.
  </done>
</task>

<task type="auto">
  <name>Task 2: Tests for report generators and GIFI export</name>
  <files>
    tests/test_rapports.py
  </files>
  <action>
    Create comprehensive test suite for the report generation module.

    **Test fixtures:**
    - Create a minimal set of Beancount entries (use `beancount.parser.parse_string`) with known balances: a few revenue entries, expense entries, and balance sheet accounts. Include GIFI metadata on open directives.
    - Known expected totals for verification.

    **Tests for BaseReport:**
    - `test_to_csv_creates_file`: Generate CSV, verify file exists and has correct headers
    - `test_to_pdf_creates_file`: Generate PDF, verify file exists and is non-empty (starts with PDF magic bytes `%PDF`)
    - `test_generate_creates_both`: Both CSV and PDF in output dir

    **Tests for Balance de verification:**
    - `test_balance_csv_columns`: CSV has 4 columns (Compte, GIFI, Debit, Credit)
    - `test_balance_totals_match`: Total debits == Total credits in CSV output
    - `test_balance_pdf_renders`: PDF file generated without error

    **Tests for Etat des resultats:**
    - `test_resultats_csv_has_revenue_and_expenses`: Both sections present
    - `test_resultats_net_income_correct`: Net = Revenue - Expenses

    **Tests for Bilan:**
    - `test_bilan_equation_balanced`: Assets = Liabilities + Equity in output
    - `test_bilan_includes_net_income`: Resultat net appears under capitaux propres

    **Tests for GIFI:**
    - `test_validate_gifi_balanced`: Passes when equation balances
    - `test_validate_gifi_imbalanced`: Returns error when equation off
    - `test_aggregate_by_gifi_sums_correctly`: Two accounts with same GIFI code get summed
    - `test_export_gifi_csv_format`: Output is `GIFI_CODE,AMOUNT` with 2 decimal places
    - `test_export_gifi_skips_zero`: Zero-balance GIFI codes not in output
    - `test_extract_gifi_map_from_entries`: Parses open directives for GIFI metadata

    **Test pattern:** Follow existing test patterns -- use `tmp_path` for output, `beancount.parser.parse_string` for test entries, assert on Decimal values.
  </action>
  <verify>
    `cd /Users/philippebeliveau/Desktop/Notebook/comptabilite && uv run pytest tests/test_rapports.py -v` all tests pass
  </verify>
  <done>
    All report generators produce correct CSV and PDF output. GIFI validation catches imbalances. GIFI CSV aggregation is verified. At least 12 tests pass.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_rapports.py -v` -- all tests green
2. `uv run python -c "from compteqc.rapports import BalanceVerification, EtatResultats, Bilan; print('All reports importable')"` -- no import errors
3. Manual spot check: generate a PDF for trial balance from test data, verify it opens and looks professional
</verification>

<success_criteria>
- Three financial statement reports generate dual-output (CSV + PDF)
- GIFI validation blocks export when accounting equation is unbalanced
- GIFI CSV correctly aggregates multiple accounts to same code
- All CSV amounts have exactly 2 decimal places (Decimal quantized)
- PDF renders with professional styling, page numbers, company header
- At least 12 tests pass covering all report types and GIFI validation
</success_criteria>

<output>
After completion, create `.planning/phases/05-reporting-cpa-export-and-document-management/05-01-SUMMARY.md`
</output>
