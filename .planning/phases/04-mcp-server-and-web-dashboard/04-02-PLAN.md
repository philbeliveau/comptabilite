---
phase: 04-mcp-server-and-web-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/compteqc/mcp/tools/categorisation.py
  - src/compteqc/mcp/tools/approbation.py
  - src/compteqc/mcp/tools/paie.py
  - src/compteqc/mcp/server.py
  - src/compteqc/mcp/services.py
  - tests/test_mcp_mutations.py
autonomous: true
requirements: [MCP-02, MCP-03, MCP-04]

must_haves:
  truths:
    - "Claude can propose a category for a transaction and receive confidence score, source tag, and French reasoning explanation"
    - "Claude can list pending transactions and batch-approve or reject them"
    - "Transactions over $2,000 require explicit confirmation via confirmer_gros_montants parameter"
    - "Claude can run a dry-run payroll calculation and then write it to the ledger"
    - "Rejected transactions can be corrected with a new account before re-queuing"
    - "Read-only mode blocks all mutation tools (approve, reject, payroll write)"
    - "Ledger reloads after every mutation to prevent stale data"
  artifacts:
    - path: "src/compteqc/mcp/tools/categorisation.py"
      provides: "proposer_categorie tool with reasoning"
      contains: "@mcp.tool"
    - path: "src/compteqc/mcp/tools/approbation.py"
      provides: "lister_pending, approuver_lot, rejeter tools with $2,000 guardrail"
      contains: "SEUIL_CONFIRMATION"
    - path: "src/compteqc/mcp/tools/paie.py"
      provides: "calculer_paie (dry-run) and lancer_paie (write) tools"
      contains: "@mcp.tool"
  key_links:
    - from: "src/compteqc/mcp/tools/categorisation.py"
      to: "src/compteqc/categorisation/pipeline.py"
      via: "PipelineCategorisation.categoriser()"
      pattern: "from compteqc.categorisation"
    - from: "src/compteqc/mcp/tools/approbation.py"
      to: "src/compteqc/categorisation/pending.py"
      via: "approuver_transactions, rejeter_transactions"
      pattern: "from compteqc.categorisation.pending"
    - from: "src/compteqc/mcp/tools/paie.py"
      to: "src/compteqc/quebec/paie"
      via: "calculer_paie, generer_transaction_paie"
      pattern: "from compteqc.quebec.paie"
---

<objective>
Implement MCP mutation tools: categorization with reasoning, batch approval with $2,000 guardrail, rejection with correction, and payroll (dry-run + write).

Purpose: Completes the MCP tool set so Claude can perform the full accounting workflow -- categorize, review, approve/reject, and run payroll -- all through conversation without leaving the Claude interface.

Output: 6 additional MCP tools (13 total) with guardrails, French reasoning, and ledger reload after mutations.
</objective>

<execution_context>
@/Users/philippebeliveau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/philippebeliveau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-mcp-server-and-web-dashboard/04-RESEARCH.md
@.planning/phases/04-mcp-server-and-web-dashboard/04-01-SUMMARY.md

# Existing modules to wrap:
@src/compteqc/categorisation/pipeline.py
@src/compteqc/categorisation/pending.py
@src/compteqc/quebec/paie/__init__.py
@src/compteqc/mcp/server.py
@src/compteqc/mcp/services.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement categorization and approval MCP tools with $2,000 guardrail</name>
  <files>
    src/compteqc/mcp/tools/categorisation.py
    src/compteqc/mcp/tools/approbation.py
    src/compteqc/mcp/services.py
    src/compteqc/mcp/server.py
  </files>
  <action>
    Create `src/compteqc/mcp/tools/categorisation.py` with 1 tool:
    1. `proposer_categorie(payee: str, narration: str, montant: str, ctx)` -- runs PipelineCategorisation and returns:
       - `compte_propose`: suggested account
       - `confiance`: float confidence score
       - `source`: "regle" / "ml" / "llm"
       - `raison`: French reasoning string that explains WHY this category was chosen:
         - For rules: "Regle '{regle_name}' correspond au beneficiaire/narration"
         - For ML: "Modele ML predit {compte} (confiance {pct}%) base sur transactions historiques similaires"
         - For LLM: "Classification LLM: {compte} ({pct}%)"
         - For none: "Aucun classificateur n'a pu determiner la categorie"
       - `est_capex`: bool, `classe_dpa`: int|None, `revue_obligatoire`: bool
    The pipeline may not be fully initialized (no ML training data, no API key). Handle gracefully -- if pipeline components are unavailable, return what the rule engine can provide and note degraded capability in the response.

    Create `src/compteqc/mcp/tools/approbation.py` with 3 tools:
    1. `lister_pending(ctx)` -- call services.lister_pending(). Returns {nb_pending, transactions: [{date, payee, narration, montant, confiance, source, compte_propose}]}.
    2. `approuver_lot(ids: list[str], confirmer_gros_montants: bool = False, ctx)` -- batch approve pending transactions.
       - Check read_only flag first. Return French error if read-only.
       - SEUIL_CONFIRMATION_MONTANT = Decimal("2000")
       - If any transaction > $2,000 and confirmer_gros_montants is False, return {status: "confirmation_requise", message, transactions_gros_montants, action: "Relancez avec confirmer_gros_montants=True"}.
       - If confirmed, call `approuver_transactions()` from pending.py.
       - After approval, call `app.reload()` to refresh in-memory entries.
       - Return {status: "ok", nb_approuve, message}.
    3. `rejeter(id: str, compte_corrige: str | None = None, raison: str | None = None, ctx)` -- reject a pending transaction.
       - Check read_only flag.
       - If compte_corrige provided, update the transaction's account before re-queuing with source="human" and confiance=1.0.
       - Call `rejeter_transactions()` from pending.py.
       - After rejection, call `app.reload()`.
       - Return {status: "ok", message}.

    The `ids` parameter for approuver_lot should use a transaction identifier. Use a composite key: "{date}|{payee}|{narration[:20]}" to match pending entries (same dedup key pattern from Phase 1).

    Update `services.py` to add any helper functions needed (e.g., `trouver_pending_par_id`).

    Update `server.py` to import the new tool modules (compteqc.mcp.tools.categorisation, .approbation).
  </action>
  <verify>
    Run `uv run python -c "from compteqc.mcp.tools.categorisation import proposer_categorie; print('OK')"` succeeds.
    Run `uv run python -c "from compteqc.mcp.tools.approbation import approuver_lot, rejeter, lister_pending; print('OK')"` succeeds.
  </verify>
  <done>
    4 mutation tools registered: proposer_categorie with French reasoning, lister_pending, approuver_lot with $2,000 guardrail and confirmer_gros_montants, rejeter with optional compte_corrige. All mutation tools check read_only and call app.reload() after writes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement payroll MCP tools and write mutation tests</name>
  <files>
    src/compteqc/mcp/tools/paie.py
    src/compteqc/mcp/server.py
    tests/test_mcp_mutations.py
  </files>
  <action>
    Create `src/compteqc/mcp/tools/paie.py` with 2 tools:
    1. `calculer_paie(salaire_brut: str, nb_periodes: int = 26, ctx)` -- dry-run payroll. Calls existing `calculer_paie()` from compteqc.quebec.paie. Returns breakdown: {salaire_brut, retenues_employe: [{nom, montant}], cotisations_employeur: [{nom, montant}], salaire_net, cout_total_employeur}. This is read-only -- no ledger write. No guardrail needed.
    2. `lancer_paie(salaire_brut: str, nb_periodes: int = 26, offset_pret: str | None = None, confirmer: bool = False, ctx)` -- compute AND write payroll to ledger.
       - Check read_only flag.
       - If salaire_brut differs from previous payroll and confirmer is False, return {status: "confirmation_requise", message: "Montant different du dernier versement. Relancez avec confirmer=True.", calcul: <dry-run results>}.
       - If salaire_brut matches previous payroll OR confirmer is True, proceed.
       - Apply $2,000 guardrail: gross salary > $2,000 always requires confirmer=True (per locked decision -- this is nearly always triggered for payroll, which is fine).
       - Call generer_transaction_paie() and write to ledger.
       - Call app.reload() after write.
       - Return {status: "ok", message, transaction_id, details: <dry-run breakdown>}.

    Update `server.py` to import compteqc.mcp.tools.paie.

    Create `tests/test_mcp_mutations.py`:
    - Test proposer_categorie returns dict with required fields (compte_propose, confiance, source, raison)
    - Test approuver_lot with $2,000 guardrail: mock pending transactions, one >$2000, verify confirmation_requise response without flag, verify approval with flag
    - Test approuver_lot in read_only mode returns French error
    - Test rejeter with compte_corrige updates the account
    - Test calculer_paie returns correct breakdown structure
    - Test lancer_paie $2,000 guardrail triggers (gross salary is almost always >$2000)
    - Test lancer_paie in read_only mode returns French error
    - Use mocking for file I/O and ledger operations -- test tool logic, not domain modules (those are already tested in Phase 2/3)
  </action>
  <verify>
    Run `cd /Users/philippebeliveau/Desktop/Notebook/comptabilite && uv run pytest tests/test_mcp_mutations.py -v` -- all tests pass.
    Run `uv run python -c "from compteqc.mcp.server import mcp; print(len(mcp._tool_manager._tools))"` shows 13 tools total.
  </verify>
  <done>
    13 MCP tools total registered on the server: 4 ledger queries + 3 Quebec queries + 1 categorization + 3 approval + 2 payroll. All mutation tools enforce read-only mode and $2,000 guardrail. Tests pass covering guardrails, read-only mode, and tool response structure.
  </done>
</task>

</tasks>

<verification>
1. `uv run python -c "from compteqc.mcp.server import mcp; print(len(mcp._tool_manager._tools))"` shows 13
2. `uv run pytest tests/test_mcp_mutations.py -v` passes all tests
3. `uv run pytest tests/test_mcp_server.py tests/test_mcp_mutations.py -v` passes all MCP tests together
4. Read-only mode blocks all 6 mutation tools
5. $2,000 guardrail enforced on approuver_lot and lancer_paie
</verification>

<success_criteria>
- 13 MCP tools registered (7 query + 6 mutation)
- proposer_categorie includes French reasoning explanation
- $2,000 guardrail on batch approval and payroll write
- Read-only mode blocks all mutations with French error messages
- Ledger reloads after every mutation
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-mcp-server-and-web-dashboard/04-02-SUMMARY.md`
</output>
