---
phase: 04-mcp-server-and-web-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - pyproject.toml
  - ledger/main.beancount
  - src/compteqc/fava_ext/__init__.py
  - src/compteqc/fava_ext/approbation/__init__.py
  - src/compteqc/fava_ext/approbation/templates/ApprobationExtension.html
  - tests/test_fava_ext.py
autonomous: true
requirements: [WEB-01, WEB-02, WEB-05]

must_haves:
  truths:
    - "Fava is installed and importable (uv run python -c 'import fava; print(fava.__version__)' succeeds)"
    - "A custom 'File d'approbation' page appears in the Fava sidebar"
    - "Pending transactions show confidence score as color-coded badge (green >= 95%, yellow 80-95%, red < 80%)"
    - "Pending transactions show AI source tag (regle/ml/llm/human) below the confidence badge"
    - "User can select multiple pending transactions and batch-approve or reject them via HTML form"
    - "Transactions over $2,000 are visually flagged in the approval queue"
    - "Fava extension shares the same pending queue as MCP (reads pending.beancount with #pending tag)"
  artifacts:
    - path: "src/compteqc/fava_ext/approbation/__init__.py"
      provides: "ApprobationExtension with batch approve/reject endpoints"
      contains: "FavaExtensionBase"
    - path: "src/compteqc/fava_ext/approbation/templates/ApprobationExtension.html"
      provides: "HTML template with confidence badges, source tags, batch selection"
      contains: "pending"
  key_links:
    - from: "src/compteqc/fava_ext/approbation/__init__.py"
      to: "src/compteqc/mcp/services.py"
      via: "lister_pending shared service"
      pattern: "from compteqc.mcp.services import"
    - from: "src/compteqc/fava_ext/approbation/__init__.py"
      to: "src/compteqc/categorisation/pending.py"
      via: "approuver_transactions, rejeter_transactions"
      pattern: "from compteqc.categorisation.pending"
    - from: "ledger/main.beancount"
      to: "src/compteqc/fava_ext/approbation"
      via: "custom fava-extension directive"
      pattern: "fava-extension.*compteqc.fava_ext.approbation"
---

<objective>
Set up Fava as the web dashboard and build the transaction approval queue extension with confidence badges and batch operations.

Purpose: Gives the user a browser-based interface for reviewing and approving AI-categorized transactions, with visual indicators for confidence level and source tag. Shares the same pending queue as MCP for consistency.

Output: Working Fava instance with standard ledger views plus a custom approval queue page with batch operations and confidence indicators.
</objective>

<execution_context>
@/Users/philippebeliveau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/philippebeliveau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-mcp-server-and-web-dashboard/04-RESEARCH.md
@.planning/phases/04-mcp-server-and-web-dashboard/04-01-SUMMARY.md
@.planning/phases/03-ai-categorization-and-review-workflow/03-02-SUMMARY.md

@src/compteqc/mcp/services.py
@src/compteqc/categorisation/pending.py
@ledger/main.beancount
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Fava, configure extensions in main.beancount, and create approval extension</name>
  <files>
    pyproject.toml
    ledger/main.beancount
    src/compteqc/fava_ext/__init__.py
    src/compteqc/fava_ext/approbation/__init__.py
    src/compteqc/fava_ext/approbation/templates/ApprobationExtension.html
  </files>
  <action>
    Add `fava>=1.30` to pyproject.toml dependencies.

    Create `src/compteqc/fava_ext/__init__.py` (empty package).

    Create `src/compteqc/fava_ext/approbation/__init__.py`:
    - Class `ApprobationExtension(FavaExtensionBase)`:
      - `report_title = "File d'approbation"`
      - `__init__`: call super().__init__(), initialize `self._pending = []`
      - `after_load_file()`: call `self._charger_pending()` to refresh pending list from ledger entries
      - `_charger_pending()`: use `lister_pending()` from services.py, reading from `self.ledger.all_entries`
      - `pending_transactions()`: return self._pending (called from template)
      - `@extension_endpoint("approuver", ["POST"])` endpoint:
        - Read `ids` from form data (request.form.getlist("ids"))
        - Read `confirmer_gros_montants` checkbox from form
        - Apply $2,000 guardrail: if any selected transaction > $2,000 and checkbox not checked, return error page
        - Call `approuver_transactions()` from pending.py with the selected entries
        - Redirect back to the extension page
      - `@extension_endpoint("rejeter", ["POST"])` endpoint:
        - Read `id` and optional `compte_corrige` from form data
        - Call `rejeter_transactions()` from pending.py
        - Redirect back to the extension page

    Create `src/compteqc/fava_ext/approbation/templates/ApprobationExtension.html`:
    - Extend `fava/templates/base.html` (use `{% set page_title = "File d'approbation" %}`)
    - Content block with:
      - Count summary: "N transaction(s) en attente de revision"
      - HTML form with POST to the "approuver" endpoint
      - Table with columns: checkbox, Date, Beneficiaire, Narration, Montant, Categorie proposee, Confiance, Source
      - Confidence badge rendering:
        - Green badge class for confiance >= 0.95: "Confiance elevee"
        - Yellow badge class for 0.80 <= confiance < 0.95: "Confiance moderee"
        - Red badge class for confiance < 0.80: "Revision requise"
      - Source tag as small text below badge: "regle", "ml", "llm", "human"
      - Transactions over $2,000 get a visual indicator (bold or icon) and the batch approve form includes a checkbox "Confirmer les montants > 2 000 $"
      - Select all / deselect all via simple JavaScript (inline, minimal)
      - Approve button and Reject button (reject goes to a separate form for single-transaction rejection with optional compte_corrige)
    - Use plain CSS classes for badges. Use Fava's existing CSS classes where possible (table, etc.). No external CSS framework needed -- Fava provides base styling.
    - Start WITHOUT HTMX (per research recommendation). Use standard HTML form POST + redirect.

    Add Fava extension registration to `ledger/main.beancount`:
    ```
    2010-01-01 custom "fava-extension" "compteqc.fava_ext.approbation"
    ```
    Add this line after the existing account declarations. Do NOT remove any existing content.
  </action>
  <verify>
    Run `uv run python -c "from compteqc.fava_ext.approbation import ApprobationExtension; print(ApprobationExtension.report_title)"` prints "File d'approbation".
    Verify template file exists: `ls src/compteqc/fava_ext/approbation/templates/ApprobationExtension.html`
    Verify fava-extension line exists in main.beancount: `grep "fava-extension.*approbation" ledger/main.beancount`
  </verify>
  <done>
    Fava dependency added. ApprobationExtension class with report_title, after_load_file, approve/reject endpoints. HTML template with confidence badges (green/yellow/red), source tags, $2,000 visual indicator, batch selection, and approve/reject forms. Extension registered in main.beancount.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test Fava extension importability and approval workflow</name>
  <files>
    tests/test_fava_ext.py
  </files>
  <action>
    Create `tests/test_fava_ext.py`:

    Test Fava installation:
    - Test `import fava; fava.__version__` succeeds (verifies fava is installed)

    Test extension importability (MEDIUM risk per research -- test early):
    - Test `from compteqc.fava_ext.approbation import ApprobationExtension` succeeds
    - Test `ApprobationExtension.report_title == "File d'approbation"`
    - Test `ApprobationExtension` is a subclass of FavaExtensionBase

    Test data layer (without running Fava server):
    - Create sample beancount entries with #pending tag and confidence/source metadata using beancount.parser.parse_string
    - Test that `lister_pending()` from services.py returns the correct pending transactions
    - Test that pending transactions include confidence, source, and compte_propose fields
    - Test confidence badge logic: write a helper `niveau_confiance(confiance: float) -> str` that returns "elevee" / "moderee" / "revision" and test it at boundaries (0.95, 0.80, 0.79)

    Test $2,000 visual flagging:
    - Test that transactions with montant > 2000 are identified for visual flagging
    - Add `est_gros_montant(montant: Decimal) -> bool` helper to the extension module and test it

    Do NOT test Fava HTTP server directly (requires running Fava process). Test the extension class methods and data logic in isolation.
  </action>
  <verify>
    Run `cd /Users/philippebeliveau/Desktop/Notebook/comptabilite && uv run pytest tests/test_fava_ext.py -v` -- all tests pass.
  </verify>
  <done>
    Fava extension importability verified. Pending transaction listing with confidence/source metadata tested. Confidence badge level boundaries tested. $2,000 flagging logic tested. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `uv run python -c "from compteqc.fava_ext.approbation import ApprobationExtension; print('OK')"` succeeds
2. `uv run pytest tests/test_fava_ext.py -v` passes all tests
3. `grep "fava-extension" ledger/main.beancount` shows the registration line
4. Template file exists at `src/compteqc/fava_ext/approbation/templates/ApprobationExtension.html`
5. Template contains confidence badge markup and batch selection form
</verification>

<success_criteria>
- Fava dependency installed and extension importable
- Approval queue extension with report_title visible in Fava sidebar
- Confidence badges: green (>= 95%), yellow (80-95%), red (< 80%) with source tag
- $2,000 flagging on large transactions
- Batch approve/reject via HTML form POST
- Shares pending queue with MCP (both read pending.beancount)
- Tests pass covering extension importability, data layer, and badge logic
</success_criteria>

<output>
After completion, create `.planning/phases/04-mcp-server-and-web-dashboard/04-03-SUMMARY.md`
</output>
