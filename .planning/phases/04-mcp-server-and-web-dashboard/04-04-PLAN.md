---
phase: 04-mcp-server-and-web-dashboard
plan: 04
type: execute
wave: 3
depends_on: ["04-01", "04-03"]
files_modified:
  - src/compteqc/fava_ext/paie_qc/__init__.py
  - src/compteqc/fava_ext/paie_qc/templates/PaieQCExtension.html
  - src/compteqc/fava_ext/taxes_qc/__init__.py
  - src/compteqc/fava_ext/taxes_qc/templates/TaxesQCExtension.html
  - src/compteqc/fava_ext/dpa_qc/__init__.py
  - src/compteqc/fava_ext/dpa_qc/templates/DpaQCExtension.html
  - src/compteqc/fava_ext/pret_actionnaire/__init__.py
  - src/compteqc/fava_ext/pret_actionnaire/templates/PretActionnaireExtension.html
  - src/compteqc/fava_ext/export_cpa/__init__.py
  - src/compteqc/fava_ext/export_cpa/templates/ExportCPAExtension.html
  - ledger/main.beancount
  - tests/test_fava_quebec.py
autonomous: true
requirements: [WEB-03, WEB-04]

must_haves:
  truths:
    - "Payroll dashboard shows YTD employee deductions and employer contributions with maximum tracking"
    - "GST/QST tracker shows collected vs ITCs/ITRs by filing period (annual/quarterly) with net remittance"
    - "CCA schedule shows UCC per class (8, 10, 12, 50, 54) with additions, disposals, CCA claimed, and carry-forward"
    - "Shareholder loan status shows net balance, movement history, and s.15(2) deadline countdown in days"
    - "CPA export stub page exists with placeholder explaining Phase 5 will implement export"
    - "All five extensions appear in the Fava sidebar"
  artifacts:
    - path: "src/compteqc/fava_ext/paie_qc/__init__.py"
      provides: "PaieQCExtension with YTD payroll data"
      contains: "FavaExtensionBase"
    - path: "src/compteqc/fava_ext/taxes_qc/__init__.py"
      provides: "TaxesQCExtension with GST/QST filing period summary"
      contains: "FavaExtensionBase"
    - path: "src/compteqc/fava_ext/dpa_qc/__init__.py"
      provides: "DpaQCExtension with CCA schedule by class"
      contains: "FavaExtensionBase"
    - path: "src/compteqc/fava_ext/pret_actionnaire/__init__.py"
      provides: "PretActionnaireExtension with s.15(2) countdown"
      contains: "FavaExtensionBase"
    - path: "src/compteqc/fava_ext/export_cpa/__init__.py"
      provides: "ExportCPAExtension stub for Phase 5"
      contains: "FavaExtensionBase"
  key_links:
    - from: "src/compteqc/fava_ext/paie_qc/__init__.py"
      to: "src/compteqc/quebec/paie/ytd.py"
      via: "calculer_ytd for YTD deductions"
      pattern: "from compteqc.quebec.paie"
    - from: "src/compteqc/fava_ext/taxes_qc/__init__.py"
      to: "src/compteqc/quebec/taxes"
      via: "GST/QST summary functions"
      pattern: "from compteqc.quebec.taxes"
    - from: "src/compteqc/fava_ext/dpa_qc/__init__.py"
      to: "src/compteqc/quebec/dpa"
      via: "CCA schedule functions"
      pattern: "from compteqc.quebec.dpa"
    - from: "src/compteqc/fava_ext/pret_actionnaire/__init__.py"
      to: "src/compteqc/quebec/pret_actionnaire"
      via: "obtenir_etat_pret for loan status"
      pattern: "from compteqc.quebec.pret_actionnaire"
---

<objective>
Build four Quebec-specific Fava extensions (payroll, GST/QST, CCA, shareholder loan) and a CPA export stub, all as custom dashboard pages in the Fava sidebar.

Purpose: Gives the user browser-based views of the most important Quebec-specific accounting data -- payroll deductions, tax tracker, CCA schedule, and shareholder loan status with compliance deadline -- directly within the Fava interface alongside the standard ledger views.

Output: Five Fava extensions registered in main.beancount, each with Python class and Jinja2 template.
</objective>

<execution_context>
@/Users/philippebeliveau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/philippebeliveau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-mcp-server-and-web-dashboard/04-RESEARCH.md
@.planning/phases/04-mcp-server-and-web-dashboard/04-03-SUMMARY.md

# Quebec domain modules to call:
@src/compteqc/quebec/paie/ytd.py
@src/compteqc/quebec/taxes/__init__.py
@src/compteqc/quebec/dpa/__init__.py
@src/compteqc/quebec/pret_actionnaire/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create payroll and GST/QST Fava extensions with templates</name>
  <files>
    src/compteqc/fava_ext/paie_qc/__init__.py
    src/compteqc/fava_ext/paie_qc/templates/PaieQCExtension.html
    src/compteqc/fava_ext/taxes_qc/__init__.py
    src/compteqc/fava_ext/taxes_qc/templates/TaxesQCExtension.html
    ledger/main.beancount
  </files>
  <action>
    Create `src/compteqc/fava_ext/paie_qc/__init__.py`:
    - Class `PaieQCExtension(FavaExtensionBase)`:
      - `report_title = "Paie Quebec"`
      - `__init__`: initialize `self._payroll_data = None`
      - `after_load_file()`: compute YTD payroll data from `self.ledger.all_entries`. Call existing `calculer_ytd()` from `compteqc.quebec.paie.ytd`. Store result.
      - `payroll_summary()`: return formatted payroll data for template. Structure: list of dicts with {nom (deduction name), employe (employee amount), employeur (employer amount), maximum (annual max), atteint (bool -- has max been reached)}.
      - Include all 7 contributions: RRQ/QPP base, QPP supp1, RQAP, AE/EI, FSS, CNESST, Normes du travail.
      - Include federal and Quebec income tax withholding YTD.

    Create `PaieQCExtension.html` template:
    - Extend `fava/templates/base.html`
    - Title: "Paie Quebec - Cumulatif annuel {annee}"
    - Table 1: "Cotisations" with columns: Cotisation, Employe YTD, Employeur YTD, Maximum annuel, Statut
      - Statut column: green checkmark or "Atteint" if max reached, amount remaining otherwise
    - Table 2: "Retenues d'impot" with columns: Palier, Impot retenu YTD
      - Show federal and Quebec income tax
    - Summary row: Total retenues employe, Total cotisations employeur, Salaire net YTD
    - Use Fava's built-in table CSS classes

    Create `src/compteqc/fava_ext/taxes_qc/__init__.py`:
    - Class `TaxesQCExtension(FavaExtensionBase)`:
      - `report_title = "TPS/TVQ"`
      - `after_load_file()`: compute GST/QST data from entries. Call existing `compteqc.quebec.taxes` module for filing period summaries.
      - `tax_summary()`: return data structured by filing period (annual or quarterly per user preference). Each period: {periode, tps_percue, tvq_percue, ctis_tps (input tax credits), rtis_tvq (input tax refunds), remise_nette_tps, remise_nette_tvq}.
      - Show real filing periods per locked decision (annual/quarterly, not calendar months).

    Create `TaxesQCExtension.html` template:
    - Extend `fava/templates/base.html`
    - Title: "TPS/TVQ - Suivi par periode de production"
    - Table with columns: Periode, TPS percue, TVQ percue, CTI (TPS paye), RTI (TVQ paye), Remise nette TPS, Remise nette TVQ
    - Summary row with annual totals
    - Use Fava table styling

    Add both extensions to `ledger/main.beancount`:
    ```
    2010-01-01 custom "fava-extension" "compteqc.fava_ext.paie_qc"
    2010-01-01 custom "fava-extension" "compteqc.fava_ext.taxes_qc"
    ```
  </action>
  <verify>
    Run `uv run python -c "from compteqc.fava_ext.paie_qc import PaieQCExtension; print(PaieQCExtension.report_title)"` prints "Paie Quebec".
    Run `uv run python -c "from compteqc.fava_ext.taxes_qc import TaxesQCExtension; print(TaxesQCExtension.report_title)"` prints "TPS/TVQ".
    Verify templates exist: `ls src/compteqc/fava_ext/paie_qc/templates/ src/compteqc/fava_ext/taxes_qc/templates/`
  </verify>
  <done>
    PaieQCExtension shows YTD for all 7 contributions plus income tax, with max-reached indicators. TaxesQCExtension shows GST/QST by filing period with net remittance. Both registered in main.beancount.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CCA, shareholder loan, and CPA export stub extensions</name>
  <files>
    src/compteqc/fava_ext/dpa_qc/__init__.py
    src/compteqc/fava_ext/dpa_qc/templates/DpaQCExtension.html
    src/compteqc/fava_ext/pret_actionnaire/__init__.py
    src/compteqc/fava_ext/pret_actionnaire/templates/PretActionnaireExtension.html
    src/compteqc/fava_ext/export_cpa/__init__.py
    src/compteqc/fava_ext/export_cpa/templates/ExportCPAExtension.html
    ledger/main.beancount
  </files>
  <action>
    Create `src/compteqc/fava_ext/dpa_qc/__init__.py`:
    - Class `DpaQCExtension(FavaExtensionBase)`:
      - `report_title = "DPA/CCA"`
      - `after_load_file()`: load CCA data from existing `compteqc.quebec.dpa` module.
      - `cca_schedule()`: return data per CCA class. Structure: list of {classe (8/10/12/50/54), description, fnacc_debut (opening UCC), acquisitions, dispositions, dpa_reclamee (CCA claimed), fnacc_fin (closing UCC)}.
      - Specifically handle classes 8, 10, 12, 50, 54 per locked decision.

    Create `DpaQCExtension.html` template:
    - Title: "Deduction pour amortissement - Exercice {annee}"
    - Table: Classe, Description, FNACC debut, Acquisitions, Dispositions, DPA reclamee, FNACC fin
    - Summary row with totals
    - Note: "Les ecritures DPA sont marquees '!' pour revision par le comptable"

    Create `src/compteqc/fava_ext/pret_actionnaire/__init__.py`:
    - Class `PretActionnaireExtension(FavaExtensionBase)`:
      - `report_title = "Pret actionnaire"`
      - `after_load_file()`: call `obtenir_etat_pret(entries, fin_exercice)` from `compteqc.quebec.pret_actionnaire` (exported in 04-01) to get loan status from ledger entries. Pass `fin_exercice` as Dec 31 of current year or derive from ledger option.
      - `loan_status()`: return {solde_net, direction ("La societe doit a l'actionnaire" or "L'actionnaire doit a la societe"), mouvements: [{date, description, montant, solde_courant}]}.
      - `s152_status()`: return {date_inclusion, jours_restants, niveau_alerte ("normal"/"attention"/"urgent"/"critique"), message}. This is the s.15(2) deadline countdown per locked decision.

    Create `PretActionnaireExtension.html` template:
    - Title: "Pret actionnaire - Statut"
    - Alert box at top if s.15(2) deadline is approaching:
      - Green: > 9 months remaining
      - Yellow ("Attention"): 6-9 months
      - Orange ("Urgent"): 30 days - 6 months
      - Red ("Critique"): < 30 days
      - Show: "Date d'inclusion s.15(2): {date} ({N} jours restants)"
    - Summary: Solde net and direction
    - Table: Date, Description, Montant, Solde courant
    - Historical movements in reverse chronological order

    Create `src/compteqc/fava_ext/export_cpa/__init__.py`:
    - Class `ExportCPAExtension(FavaExtensionBase)`:
      - `report_title = "Export CPA"`
      - Stub implementation: `after_load_file()` does nothing.

    Create `ExportCPAExtension.html` template:
    - Title: "Export CPA - Package pour le comptable"
    - Message: "Cette fonctionnalite sera implementee dans la Phase 5. Elle generera un package complet incluant: balance de verification, etat des resultats, bilan, annexe de paie, cedule DPA, sommaire TPS/TVQ, et continuite du pret actionnaire."
    - List of planned export formats: CSV, PDF

    Add three extensions to `ledger/main.beancount`:
    ```
    2010-01-01 custom "fava-extension" "compteqc.fava_ext.dpa_qc"
    2010-01-01 custom "fava-extension" "compteqc.fava_ext.pret_actionnaire"
    2010-01-01 custom "fava-extension" "compteqc.fava_ext.export_cpa"
    ```
  </action>
  <verify>
    Run `grep "fava-extension" ledger/main.beancount | wc -l` shows 6 lines (approbation + 5 new).
    Run `uv run python -c "from compteqc.fava_ext.pret_actionnaire import PretActionnaireExtension; print(PretActionnaireExtension.report_title)"` prints "Pret actionnaire".
    Run `uv run python -c "from compteqc.fava_ext.dpa_qc import DpaQCExtension; from compteqc.fava_ext.export_cpa import ExportCPAExtension; print('OK')"` succeeds.
  </verify>
  <done>
    All 3 remaining Quebec extensions (CCA, shareholder loan) plus CPA export stub created with Python classes and Jinja2 templates. All registered in main.beancount. Shareholder loan includes s.15(2) countdown with color-coded alert levels. CCA shows all 5 classes (8, 10, 12, 50, 54).
  </done>
</task>

<task type="auto">
  <name>Task 3: Test all Quebec Fava extensions</name>
  <files>
    tests/test_fava_quebec.py
  </files>
  <action>
    Create `tests/test_fava_quebec.py`:
    - Test all 5 Quebec/utility extensions are importable and have correct report_title:
      - PaieQCExtension: "Paie Quebec"
      - TaxesQCExtension: "TPS/TVQ"
      - DpaQCExtension: "DPA/CCA"
      - PretActionnaireExtension: "Pret actionnaire"
      - ExportCPAExtension: "Export CPA"
    - Test all are subclasses of FavaExtensionBase
    - Test template files exist for each extension (check file paths)
    - Test main.beancount has all 6 fava-extension directives (1 from 04-03 + 5 total)
    - Test s152 alert level logic: helper function that maps jours_restants to niveau_alerte
  </action>
  <verify>
    Run `cd /Users/philippebeliveau/Desktop/Notebook/comptabilite && uv run pytest tests/test_fava_quebec.py -v` -- all tests pass.
  </verify>
  <done>
    Tests pass for importability, report titles, template existence, beancount registration count, and s152 alert logic.
  </done>
</task>

</tasks>

<verification>
1. All 6 Fava extensions importable: `uv run python -c "from compteqc.fava_ext.approbation import ApprobationExtension; from compteqc.fava_ext.paie_qc import PaieQCExtension; from compteqc.fava_ext.taxes_qc import TaxesQCExtension; from compteqc.fava_ext.dpa_qc import DpaQCExtension; from compteqc.fava_ext.pret_actionnaire import PretActionnaireExtension; from compteqc.fava_ext.export_cpa import ExportCPAExtension; print('All OK')"`
2. `uv run pytest tests/test_fava_quebec.py -v` passes all tests
3. `grep -c "fava-extension" ledger/main.beancount` returns 6
4. All template files exist in their respective `templates/` directories
5. Shareholder loan template includes s.15(2) alert with countdown
6. CCA template lists classes 8, 10, 12, 50, 54
</verification>

<success_criteria>
- Payroll dashboard shows all 7 contributions + income tax with YTD and max tracking
- GST/QST tracker shows filing period summaries (annual/quarterly) with net remittance
- CCA schedule shows 5 classes with UCC opening/closing, additions, disposals, CCA claimed
- Shareholder loan page shows s.15(2) deadline countdown with color-coded alert
- CPA export stub exists with Phase 5 placeholder
- All 6 extensions registered in main.beancount and importable
- Tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-mcp-server-and-web-dashboard/04-04-SUMMARY.md`
</output>
