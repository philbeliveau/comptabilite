---
phase: 04-mcp-server-and-web-dashboard
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/compteqc/fava_ext/echeances/__init__.py
  - src/compteqc/fava_ext/echeances/templates/EcheancesExtension.html
  - src/compteqc/fava_ext/recus/__init__.py
  - src/compteqc/fava_ext/recus/templates/RecusExtension.html
  - ledger/main.beancount
  - tests/test_fava_gap_closure.py
autonomous: true
gap_closure: true
requirements: []

must_haves:
  truths:
    - "Fava sidebar shows an Echeances page that displays filing deadline alert banners"
    - "Fava sidebar shows a Recus page with a drag-and-drop file upload zone"
    - "EcheancesExtension calls Phase 5 echeances API when available, shows placeholder otherwise"
    - "RecusExtension POST endpoint accepts uploaded files and calls Phase 5 documents API when available"
    - "Both extensions registered in ledger/main.beancount (total 8 extensions)"
    - "All existing tests still pass"
  artifacts:
    - path: "src/compteqc/fava_ext/echeances/__init__.py"
      provides: "EcheancesExtension with pluggable alert interface for Phase 5"
      contains: "FavaExtensionBase"
    - path: "src/compteqc/fava_ext/echeances/templates/EcheancesExtension.html"
      provides: "Dashboard alert banners with color-coded urgency levels"
      contains: "alerte"
    - path: "src/compteqc/fava_ext/recus/__init__.py"
      provides: "RecusExtension with upload POST endpoint for Phase 5"
      contains: "FavaExtensionBase"
    - path: "src/compteqc/fava_ext/recus/templates/RecusExtension.html"
      provides: "Drag-and-drop upload zone with JavaScript file handling"
      contains: "drop"
    - path: "ledger/main.beancount"
      provides: "8 fava-extension directives"
      contains: "compteqc.fava_ext.recus"
  key_links:
    - from: "src/compteqc/fava_ext/echeances/__init__.py"
      to: "src/compteqc/echeances/calendrier.py"
      via: "Try-import pattern: imports calculer_echeances and obtenir_alertes when Phase 5 exists"
      pattern: "try.*import.*calculer_echeances"
    - from: "src/compteqc/fava_ext/recus/__init__.py"
      to: "src/compteqc/documents/upload.py"
      via: "Try-import pattern: imports upload function when Phase 5 exists"
      pattern: "try.*import.*upload"
---

<objective>
Create two Fava extensions deferred from Phase 5 planning: filing deadline alert banners and drag-and-drop receipt upload.

Purpose: Phase 5 CONTEXT.md explicitly deferred the Fava UI layer for these features to Phase 4. The alert banners extension surfaces deadline urgency in the web dashboard (primary alerting channel per user decision). The receipt upload extension provides the web-based drag-and-drop interface for receipt ingestion. Both define pluggable interfaces that Phase 5 modules will implement.

Output: Two new Fava extensions (echeances, recus) with Python classes, HTML templates, and tests. Both registered in main.beancount.
</objective>

<execution_context>
@/Users/philippebeliveau/.claude/get-shit-done/workflows/execute-plan.md
@/Users/philippebeliveau/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-mcp-server-and-web-dashboard/04-VERIFICATION.md
@.planning/phases/05-reporting-cpa-export-and-document-management/05-CONTEXT.md

# Existing extension pattern to follow:
@src/compteqc/fava_ext/approbation/__init__.py
@src/compteqc/fava_ext/export_cpa/__init__.py
@src/compteqc/fava_ext/export_cpa/templates/ExportCPAExtension.html

# Phase 5 interfaces this will connect to:
@.planning/phases/05-reporting-cpa-export-and-document-management/05-04-PLAN.md
@.planning/phases/05-reporting-cpa-export-and-document-management/05-05-PLAN.md

# Existing test patterns:
@tests/test_fava_quebec.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EcheancesExtension and RecusExtension with templates</name>
  <files>
    src/compteqc/fava_ext/echeances/__init__.py
    src/compteqc/fava_ext/echeances/templates/EcheancesExtension.html
    src/compteqc/fava_ext/recus/__init__.py
    src/compteqc/fava_ext/recus/templates/RecusExtension.html
  </files>
  <action>
    **EcheancesExtension** (`src/compteqc/fava_ext/echeances/__init__.py`):

    Class `EcheancesExtension(FavaExtensionBase)`:
    - `report_title = "Echeances"`
    - `__init__`: initialize `self._alertes: list[dict] = []` and `self._echeances_disponible: bool = False`
    - `after_load_file()`: Use try/except ImportError pattern to call Phase 5's `calculer_echeances()` and `obtenir_alertes()` from `compteqc.echeances.calendrier`. If import succeeds:
      - Call `calculer_echeances(fin_exercice)` with Dec 31 of current year (or derive from ledger option "fiscal_year_end" if available)
      - Call `obtenir_alertes(echeances)` to get active alerts
      - Store as list of dicts: `{type, date_limite, description, jours_restants, urgence}` where urgence is "critique"/"urgent"/"normal"/"info"
      - Set `self._echeances_disponible = True`
    - If import fails (Phase 5 not yet built):
      - `self._alertes = []`
      - `self._echeances_disponible = False`
    - `alertes() -> list[dict]`: return self._alertes
    - `echeances_disponible() -> bool`: return self._echeances_disponible

    Helper function `couleur_urgence(urgence: str) -> str`:
    - Maps urgence levels to CSS color classes:
      - "critique" -> "alerte-critique" (red)
      - "urgent" -> "alerte-urgent" (orange)
      - "normal" -> "alerte-normal" (yellow)
      - "info" -> "alerte-info" (blue)
      - default -> "alerte-info"

    **EcheancesExtension.html** template:
    - `{% set page_title = "Echeances" %}`
    - Title: "Echeances et rappels de production"
    - CSS classes for 4 urgency levels (`.alerte-critique` red, `.alerte-urgent` orange, `.alerte-normal` yellow, `.alerte-info` blue), styled as banner divs with border-left accent
    - If `extension.echeances_disponible()` is True:
      - If alertes is not empty: render each as a color-coded banner showing: urgence icon, description, date_limite, jours_restants ("dans N jours")
      - If alertes empty: green "Aucune echeance imminente" message
    - If not disponible: show a Phase 5 placeholder box (same style as ExportCPAExtension) explaining: "Le module d'echeances sera disponible apres l'implementation de la Phase 5. Il affichera les echeances de production (TPS/TVQ, T2, CO-17, T4/RL-1, remises de paie) et les alertes de pret actionnaire s.15(2)."
    - List of deadline types that will be tracked: TPS/TVQ trimestriel, T2, CO-17, T4/RL-1, Remises de paie, Pret actionnaire s.15(2)

    **RecusExtension** (`src/compteqc/fava_ext/recus/__init__.py`):

    Class `RecusExtension(FavaExtensionBase)`:
    - `report_title = "Recus"`
    - `__init__`: initialize `self._upload_disponible: bool = False` and `self._recent_uploads: list[dict] = []`
    - `after_load_file()`: Use try/except ImportError to check if `compteqc.documents.upload` exists. If it does, set `self._upload_disponible = True`. Also scan for recent document directives in ledger entries (last 10) to show in "recent uploads" list.
    - `upload_disponible() -> bool`: return self._upload_disponible
    - `recent_uploads() -> list[dict]`: return self._recent_uploads (list of {date, filename, account})

    POST endpoint using `@extension_endpoint("upload", ["POST"])`:
    - Accept file from `request.files.get("fichier")`
    - If no file: return error HTML
    - If Phase 5 upload module available:
      - Import `compteqc.documents.upload` and call its upload function, passing the file and the ledger documents directory (`ledger_path.parent / "documents"`)
      - Import `compteqc.documents.extraction` and call extraction on the uploaded file
      - Return success HTML with extracted data summary
    - If Phase 5 not available:
      - Save file to `ledger_path.parent / "documents" / filename` (ensure directory exists with `mkdir(parents=True, exist_ok=True)`)
      - Return success HTML: "Fichier enregistre. L'extraction automatique sera disponible dans la Phase 5."
    - After upload, call `self.ledger.load_file()` to refresh

    **RecusExtension.html** template:
    - `{% set page_title = "Recus" %}`
    - Title: "Televersement de recus et factures"
    - Drag-and-drop zone styled as a large dashed-border area:
      - CSS: `.dropzone` with dashed border, light background, centered text, min-height 200px
      - `.dropzone.dragover` with highlight color when file is being dragged over
    - Form with `enctype="multipart/form-data"` POSTing to the upload endpoint
    - Hidden file input (`<input type="file" name="fichier" accept=".pdf,.jpg,.jpeg,.png,.heic">`)
    - JavaScript:
      - `dragover`, `dragleave`, `drop` event handlers on the dropzone
      - On drop: set the file input's files property and submit the form
      - On click of dropzone: trigger file input click
      - Visual feedback: change border color and text on dragover
    - If `extension.upload_disponible()` is False: show info banner "L'extraction automatique par IA sera disponible apres la Phase 5. Les fichiers telecharges seront conserves dans le dossier documents/."
    - Section "Recus recents" showing `extension.recent_uploads()` as a table (Date, Fichier, Compte) or "Aucun recu recent" if empty
    - Accepted file types note: "Formats acceptes : PDF, JPEG, PNG, HEIC"
  </action>
  <verify>
    1. `uv run python -c "from compteqc.fava_ext.echeances import EcheancesExtension; print(EcheancesExtension.report_title)"` prints "Echeances"
    2. `uv run python -c "from compteqc.fava_ext.recus import RecusExtension; print(RecusExtension.report_title)"` prints "Recus"
    3. `ls src/compteqc/fava_ext/echeances/templates/EcheancesExtension.html src/compteqc/fava_ext/recus/templates/RecusExtension.html` both exist
    4. `uv run python -c "from compteqc.fava_ext.echeances import couleur_urgence; assert couleur_urgence('critique') == 'alerte-critique'; print('OK')"` passes
  </verify>
  <done>
    EcheancesExtension renders color-coded alert banners when Phase 5 echeances module exists, and a placeholder when it does not. RecusExtension provides drag-and-drop upload with JavaScript, saves files to documents/ directory, and will call Phase 5 extraction when available. Both follow the established FavaExtensionBase pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register extensions in main.beancount and add tests</name>
  <files>
    ledger/main.beancount
    tests/test_fava_gap_closure.py
  </files>
  <action>
    **Register in main.beancount:**
    Add two new extension directives after the existing 6:
    ```
    2010-01-01 custom "fava-extension" "compteqc.fava_ext.echeances"
    2010-01-01 custom "fava-extension" "compteqc.fava_ext.recus"
    ```
    Total should be 8 fava-extension directives.

    **Update existing test** (`tests/test_fava_quebec.py`):
    - Update `test_main_beancount_has_all_extensions` to expect 8 instead of 6
    - Add "compteqc.fava_ext.echeances" and "compteqc.fava_ext.recus" to the expected list in `test_main_beancount_has_specific_extensions`
    - Add EcheancesExtension and RecusExtension to the parametrized `test_subclass_of_fava_extension_base` list
    - Add template paths for both new extensions to `test_template_exists`
    - Add `(EcheancesExtension, "Echeances")` and `(RecusExtension, "Recus")` to `test_report_title`

    **Create `tests/test_fava_gap_closure.py`** for gap-closure-specific tests:
    - Import EcheancesExtension, RecusExtension, couleur_urgence from their modules
    - `test_echeances_importable`: Import succeeds, is subclass of FavaExtensionBase
    - `test_recus_importable`: Import succeeds, is subclass of FavaExtensionBase
    - `test_couleur_urgence_mapping`: Test all 4 urgence levels map to correct CSS classes:
      - "critique" -> "alerte-critique"
      - "urgent" -> "alerte-urgent"
      - "normal" -> "alerte-normal"
      - "info" -> "alerte-info"
    - `test_couleur_urgence_default`: Unknown value -> "alerte-info"
    - `test_echeances_graceful_without_phase5`: Instantiate EcheancesExtension with a mock ledger (or verify that the try/except pattern means `echeances_disponible()` returns False when `compteqc.echeances` does not exist). Test: `assert ext.echeances_disponible() is False` and `assert ext.alertes() == []`
    - `test_recus_graceful_without_phase5`: Similar -- `upload_disponible()` returns False when `compteqc.documents` module does not exist
    - `test_main_beancount_8_extensions`: Verify 8 fava-extension directives in main.beancount
    - `test_templates_exist_gap_closure`: Verify EcheancesExtension.html and RecusExtension.html exist

    **Running existing tests:**
    Run `uv run pytest tests/test_fava_quebec.py tests/test_fava_ext.py tests/test_fava_gap_closure.py -v` to confirm all pass. The updated counts in test_fava_quebec.py (8 extensions) must match reality.
  </action>
  <verify>
    1. `grep -c "fava-extension" ledger/main.beancount` returns 8
    2. `cd /Users/philippebeliveau/Desktop/Notebook/comptabilite && uv run pytest tests/test_fava_gap_closure.py -v` all pass
    3. `cd /Users/philippebeliveau/Desktop/Notebook/comptabilite && uv run pytest tests/test_fava_quebec.py -v` all pass (updated counts)
    4. `cd /Users/philippebeliveau/Desktop/Notebook/comptabilite && uv run pytest tests/test_fava_ext.py -v` all pass (unchanged)
  </verify>
  <done>
    8 extensions registered in main.beancount. All new tests pass: importability, CSS color mapping, graceful degradation without Phase 5 modules, template existence, and directive count. Existing tests updated and still green.
  </done>
</task>

</tasks>

<verification>
1. `uv run python -c "from compteqc.fava_ext.echeances import EcheancesExtension; from compteqc.fava_ext.recus import RecusExtension; print('Both OK')"` succeeds
2. `grep -c 'fava-extension' ledger/main.beancount` returns 8
3. `uv run pytest tests/test_fava_gap_closure.py tests/test_fava_quebec.py tests/test_fava_ext.py -v` all tests pass
4. All template files exist in their `templates/` directories
5. EcheancesExtension degrades gracefully when Phase 5 echeances module not available
6. RecusExtension degrades gracefully when Phase 5 documents module not available
7. RecusExtension template has drag-and-drop JavaScript and POST form
8. EcheancesExtension template has 4 urgency-level CSS banner styles
</verification>

<success_criteria>
- EcheancesExtension displays alert banners with 4 color-coded urgency levels when Phase 5 exists
- EcheancesExtension shows informative placeholder when Phase 5 not yet built
- RecusExtension provides drag-and-drop file upload zone with JavaScript event handlers
- RecusExtension POST endpoint saves files and calls Phase 5 extraction when available
- Both extensions follow the exact FavaExtensionBase pattern as existing extensions
- 8 total fava-extension directives in main.beancount
- All existing and new tests pass
- Phase 5 can plug in by implementing the expected module paths (compteqc.echeances.calendrier, compteqc.documents.upload)
</success_criteria>

<output>
After completion, create `.planning/phases/04-mcp-server-and-web-dashboard/04-05-SUMMARY.md`
</output>
